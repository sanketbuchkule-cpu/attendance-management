<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave & NSA Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#002147">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>

 <style>
    /* --- DEALERON CORPORATE THEME VARIABLES --- */
    :root {
        --dealeron-navy: #002d5b;      /* Primary Corporate Blue */
        --dealeron-blue: #0056b3;      /* Action Blue */
        --dealeron-orange: #ff8c00;    /* Accent/Alert Orange */
        --dealeron-bg: #f4f7f9;        /* Slate Background */
        --dealeron-surface: #ffffff;
        --dealeron-border: #e2e8f0;
        --dealeron-text: #1e293b;
    }

    /* Global Background & Base Typography */
    body { 
        background: var(--dealeron-bg); 
        font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
        color: var(--dealeron-text);
        line-height: 1.6;
    }

    /* --- ENHANCED CARDS --- */
    .card { 
        border-radius: 12px; 
        box-shadow: 0 4px 15px rgba(0, 45, 91, 0.08); 
        border: 1px solid var(--dealeron-border);
        background: var(--dealeron-surface);
        transition: transform 0.2s ease;
    }
    
    .card-header {
        background-color: var(--dealeron-navy);
        color: white;
        font-weight: 600;
        border-radius: 12px 12px 0 0 !important;
    }

    /* --- NAVIGATION & TABS --- */
    .navbar {
        background: var(--dealeron-navy) !important;
        padding: 1rem 0;
    }

    .nav-tabs { border-bottom: 2px solid var(--dealeron-border); }
    .nav-tabs .nav-link { 
        color: #64748b; 
        font-weight: 600; 
        border: none; 
        padding: 12px 24px; 
        transition: 0.3s;
    }
    .nav-tabs .nav-link.active { 
        color: var(--dealeron-navy) !important; 
        border-bottom: 3px solid var(--dealeron-orange) !important; 
        background: transparent; 
    }

    /* --- UPDATED CALENDAR UI --- */
    #calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
        padding: 15px;
        background: white;
        border-radius: 12px;
    }
    
    .date-cell {
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 10px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        border: 1px solid var(--dealeron-border);
        background-color: #fff;
        position: relative;
    }

    .date-cell:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 2;
    }

    /* Status-Based Block Colors (Dealeron Palette) */
    .date-cell.bg-success { 
        background-color: #ecfdf5 !important; 
        color: #065f46 !important; 
        border: 2px solid #10b981 !important; 
    }
    .date-cell.bg-danger { 
        background-color: #fef2f2 !important; 
        color: #991b1b !important; 
        border: 2px solid #ef4444 !important; 
    }
    .date-cell.bg-info { 
        background-color: #f0f9ff !important; 
        color: #075985 !important; 
        border: 2px solid var(--dealeron-blue) !important; 
    }
    
    .date-cell.weekend { background-color: #f8fafc; color: #94a3b8; border-style: dashed; }
    .date-cell.holiday { 
        background-color: #fffbeb; 
        color: #92400e; 
        border: 2px solid var(--dealeron-orange) !important; 
    }
    
    .date-cell.selected { 
        border: 3px solid var(--dealeron-orange) !important; 
        box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.2);
    }

    /* --- TABLES --- */
    .table thead th {
        background-color: var(--dealeron-navy);
        color: white;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 15px;
        border: none;
    }

    .table tbody tr:hover {
        background-color: rgba(0, 45, 91, 0.02) !important;
    }

    /* --- SUMMARY UI CARDS (Border-Start Method) --- */
    .summary-card-present { border-left: 5px solid #10b981; }
    .summary-card-leave { border-left: 5px solid var(--dealeron-blue); }
    .summary-card-holiday { border-left: 5px solid var(--dealeron-orange); }

    /* NSA Hero Card */
    .nsa-total-card {
        background: linear-gradient(135deg, var(--dealeron-navy) 0%, #004a99 100%);
        color: white;
        border: none;
    }
    .nsa-amount-text {
        color: var(--dealeron-orange);
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* --- BUTTONS --- */
    /* --- UNIFORM BUTTON STYLING --- */
/* This targets all Bootstrap button variants to ensure they match perfectly */
.btn-primary, .btn-success, .btn-danger, .btn-warning, .btn-info, .btn-secondary {
    padding: 10px 24px !important; /* Increased horizontal padding for a premium feel */
    font-weight: 600 !important;
    border-radius: 8px !important;
    border: none !important;
    transition: all 0.3s ease !important;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* Space between icon and text */
    font-size: 0.95rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Hover Effects - Slight lift and shadow */
.btn-primary:hover, .btn-success:hover, .btn-danger:hover, .btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    filter: brightness(90%); /* Slightly darkens on hover for feedback */
}

/* Specific Dealeron Primary Hover */
.btn-primary:hover { background-color: var(--dealeron-navy) !important; }

/* Active/Click effect */
.btn-primary:active, .btn-success:active {
    transform: translateY(0);
}

.search-wrapper {
    position: relative;
}
.search-wrapper i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
}
#employeeSearch {
    padding-left: 35px;
    transition: all 0.3s ease;
    border: 1.5px solid var(--dealeron-border);
}
#employeeSearch:focus {
    width: 300px; /* Expands slightly when clicking */
    border-color: var(--dealeron-orange);
    box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.1);
}

    /* --- TOOLTIPS --- */
    [data-tooltip] { position: relative; cursor: help; }
    [data-tooltip]::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--dealeron-navy);
        color: #fff;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: 0.3s;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
    }
    [data-tooltip]:hover::before { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-5px); }

    /* --- MOBILE RESPONSIVE --- */
    @media (max-width: 768px) {
        #calendar { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
        .date-cell { min-height: 80px; }
        .nsa-total-card .display-4 { font-size: 2rem; }
        .gap-1 {
    gap: 0rem !important;
}
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--dealeron-bg); }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--dealeron-blue); }

    /* Table row hover highlight */
tbody tr:hover {
  background-color: rgba(255, 140, 0, 0.05) !important; /* Very subtle Dealeron Accent orange */
  cursor: pointer;
}

/* Custom scrollbar for better UI */
::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-track {
  background: #f1f1f1;
}
::-webkit-scrollbar-thumb {
  background: var(--dealeron-primary);
  border-radius: 10px;
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    position: relative;
}
.status-active { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
.status-inactive { background-color: #ef4444; }

/* Subtle pulse animation for Active employees */
.pulse {
    animation: pulse-animation 2s infinite;
}
@keyframes pulse-animation {
    0% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.4); }
    100% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
}

/* Status Pill Styling */
.status-pill {
    padding: 6px 12px;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    letter-spacing: 0.02em;
}

/* Active State: Emerald Green */
.pill-active {
    background-color: #ecfdf5;
    color: #059669;
    border: 1px solid #d1fae5;
}

/* Inactive State: Rose Red */
.pill-inactive {
    background-color: #fff1f2;
    color: #e11d48;
    border: 1px solid #ffe4e6;
}

/* Optional: Pulse dot for Active status */
.pill-active::before {
    content: "";
    width: 6px;
    height: 6px;
    background-color: #10b981;
    border-radius: 50%;
}

/* Enhanced Shift Badges */
.shift-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    display: inline-block;
    letter-spacing: 0.03em;
    text-transform: uppercase;
}

/* Morning Shift: Deep Azure Blue */
.shift-morning {
    background-color: #e0f2fe;
    color: #0369a1; /* Darker blue for contrast */
    border: 1px solid #bae6fd;
}

/* Night Shift: Deep Indigo/Purple */
.shift-night {
    background-color: #f5f3ff;
    color: #5b21b6; /* Darker purple for contrast */
    border: 1px solid #ddd6fe;
}

/* Evening/Other Shift: Slate Gray */
.shift-other {
    background-color: #f1f5f9;
    color: #334155;
    border: 1px solid #e2e8f0;
}

/* Department Badge Base */
.dept-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.72rem;
    font-weight: 600;
    display: inline-block;
    border: 1px solid transparent;
}

/* Design: Soft Orange/Peach */
.dept-design {
    background-color: #fff7ed;
    color: #c2410c;
    border-color: #ffedd5;
}

/* Sales: Soft Green */
.dept-sales {
    background-color: #f0fdf4;
    color: #15803d;
    border-color: #dcfce7;
}

/* HR: Soft Purple */
.dept-hr {
    background-color: #faf5ff;
    color: #7e22ce;
    border-color: #f3e8ff;
}

/* Tech/IT: Soft Blue-Grey */
.dept-tech {
    background-color: #f8fafc;
    color: #334155;
    border-color: #e2e8f0;
}

/* Default/Other: Standard Light */
.dept-default {
    background-color: #f9fafb;
    color: #4b5563;
    border-color: #f3f4f6;
}

/* Styling for the 'Visible' and 'Month (No Weekends)' buttons */
.btn-outline-navy {
    color: #002147;
    border: 2px solid #002147 !important;
    background-color: transparent;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn-outline-navy:hover {
    background-color: #002147;
    color: #ffffff;
}

/* Specific fix for the Month (No Weekends) button to make it look like a real button */
#advancedBulkModal .btn-outline-primary {
    border: 2px solid #002147 !important;
    color: #002147 !important;
    background-color: #f8f9fa;
}

#advancedBulkModal .btn-outline-primary:hover {
    background-color: #e9ecef;
    border-color: #002147 !important;
}

/* Custom DealerOn Danger Button Styles */
.btn-outline-danger {
    color: #dc3545;
    border: 2px solid #dc3545 !important; /* Bold border like your other buttons */
    font-weight: 700;
    transition: all 0.2s ease-in-out;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
}

/* Ensure the trash icon in the group looks consistent */
.btn-group .btn-outline-danger {
    color: #dc3545;
}

.btn-group .btn-outline-danger:hover {
    background-color: #fff5f5;
    color: #a71d2a;
}

/* Custom DealerOn Pills */
#dateTab .nav-link {
    color: #002147; /* Navy for inactive text */
    transition: all 0.3s ease;
}

#dateTab .nav-link:hover {
    background-color: rgba(0, 33, 71, 0.05);
}

#dateTab .nav-link.active {
    background-color: #002147 !important; /* Navy for active background */
    color: white !important; /* White for active text */
    box-shadow: 0 2px 4px rgba(0, 33, 71, 0.2);
}

@media (max-width: 768px) {
    /* 1. Header & Buttons Optimization */
    .d-flex.gap-2.flex-wrap {
        width: 100%;
        display: grid !important;
        grid-template-columns: 1fr 1fr; /* Buttons in 2 columns */
        gap: 10px !important;
    }
    
    .d-flex.gap-2.flex-wrap .btn, 
    .d-flex.gap-2.flex-wrap .dropdown,
    .d-flex.gap-2.flex-wrap .dropdown-toggle {
        width: 100% !important;
        margin: 0 !important;
    }

    /* 2. Transform Table to Cards */
    #employeeTable thead {
        display: none; /* Hide headers on mobile */
    }

    #employeeTable, #employeeTable tbody, #employeeTable tr, #employeeTable td {
        display: block;
        width: 100%;
    }

    #employeeTable tr {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fff;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
    }

    #employeeTable td {
        text-align: right;
        padding-left: 50%;
        position: relative;
        border: none;
        padding-top: 8px;
        padding-bottom: 8px;
        min-height: 40px;
    }

    /* Create Labels for the data */
    #employeeTable td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        font-weight: bold;
        text-align: left;
        color: #002147;
        text-transform: uppercase;
        font-size: 0.75rem;
    }

    /* Handle the Checkbox and Actions specifically */
    #employeeTable td:first-child {
        text-align: left;
        padding-left: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    #employeeTable td:first-child::before { content: ""; }

    #employeeTable td:last-child {
        text-align: center;
        padding-left: 10px;
        border-top: 1px solid #eee;
        margin-top: 10px;
    }
    #employeeTable td:last-child::before { content: ""; position: relative; width: 0; }
}

@media (max-width: 768px) {
    /* 1. Stack the Header and Filter */
    #activity-content .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 20px !important;
    }

    /* 2. Fix the Filter and Refresh Button width */
    #activity-content .d-flex.gap-2 {
        width: 100% !important;
        display: flex !important;
    }

    #activity-content .input-group.input-group-sm {
        width: 100% !important; /* Dropdown takes full width */
    }

    #activity-content .btn-navy {
        width: auto !important; /* Keep refresh button compact */
    }

    /* 3. Transform Table to Mobile Cards */
    #activityLogTableBody {
        display: block;
    }

    #activityLogTableBody tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 10px;
        background: #fff;
    }

    #activityLogTableBody td {
        display: block;
        text-align: right;
        padding: 8px 5px;
        border: none;
        position: relative;
    }

    /* Add labels for mobile cards */
    #activityLogTableBody td::before {
        content: attr(data-label);
        position: absolute;
        left: 5px;
        font-weight: bold;
        color: #002147;
        text-transform: uppercase;
        font-size: 0.7rem;
    }

    /* Hide the original header row on mobile */
    #activity-content thead {
        display: none;
    }
}


@media (max-width: 768px) {
    /* 1. Stack the Header and Export Buttons */
    #reporting-content .d-flex.justify-content-between.align-items-center {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 15px !important;
    }

    #reporting-content .d-flex.gap-2 {
        width: 100% !important;
    }

    #reporting-content .btn {
        flex-grow: 1 !important;
    }

    /* 2. Transform the Monthly Table into Cards */
    #deptMonthlySummary thead {
        display: none !important; /* Hide headers on mobile */
    }

    #deptMonthlySummary, 
    #deptMonthlySummary tbody, 
    #deptMonthlySummary tr, 
    #deptMonthlySummary td {
        display: block !important;
        width: 100% !important;
    }

    #deptMonthlySummary tr {
        margin-bottom: 20px !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 12px !important;
        padding: 10px !important;
        background: #fff !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
    }

    #deptMonthlySummary td {
        text-align: right !important;
        padding: 8px 10px !important;
        border: none !important;
        position: relative !important;
        min-height: 38px;
    }

    /* Create the Left Labels using data-label */
    #deptMonthlySummary td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        font-weight: bold;
        color: #002147;
        text-transform: uppercase;
        font-size: 0.7rem;
    }

    /* Specifically style the Employee Name to stand out */
    #deptMonthlySummary td:first-child {
        background-color: #f8f9fa;
        border-radius: 8px;
        text-align: left !important;
        padding-left: 10px !important;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    #deptMonthlySummary td:first-child::before { content: ""; }

    /* Highlight Total NSA at the bottom */
    #deptMonthlySummary td:last-child {
        border-top: 1px dashed #dee2e6 !important;
        margin-top: 5px;
        color: #FF8C00 !important;
        font-weight: bold;
    }
}

@media (max-width: 768px) {
    /* Ensure the footer can grow to fit wrapped content */
    .card-footer {
        padding: 15px 10px !important;
    }

    /* Stack the "Showing x of x" and the buttons vertically */
    .card-footer .d-flex.justify-content-between {
        flex-direction: column !important;
        gap: 15px !important;
        align-items: center !important;
        text-align: center !important;
    }

    /* Allow pagination buttons to wrap so they stay inside the box */
    .pagination {
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 5px !important;
    }

    /* Optional: Make buttons slightly smaller to fit more on one line */
    .page-link {
        padding: 8px 12px !important;
        font-size: 0.8rem !important;
    }
}

</style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #002147 0%, #003366 100%); z-index:9999; display:none; align-items:center; justify-content:center; padding: 20px;">
    <div class="card border-0 shadow-lg" style="width:100%; max-width:400px; border-radius:15px; overflow:hidden;">
        <div style="height: 5px; background: #FF8C00;"></div>
        
        <div class="card-body p-4 p-md-5 bg-white">
            <div class="text-center mb-4">
                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3" style="width: 70px; height: 70px; background: rgba(0, 33, 71, 0.05);">
                    <i class="bi bi-shield-lock-fill" style="font-size: 2rem; color: #002147;"></i>
                </div>
                <h3 class="fw-bold" style="color: #002147;">Login Portal</h3>
                <p class="text-muted small">Please enter your credentials</p>
            </div>

            <div class="mb-3">
                <label class="form-label small fw-bold text-uppercase text-muted">Email Address</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope text-muted"></i></span>
                    <input type="email" id="loginEmail" class="form-control border-start-0 bg-light" placeholder="name@company.com">
                </div>
            </div>

            <div class="mb-4">
    <label class="form-label small fw-bold text-uppercase text-muted">Password</label>
    <div class="input-group">
        <span class="input-group-text bg-light border-end-0"><i class="bi bi-key text-muted"></i></span>
        <input type="password" id="loginPassword" class="form-control border-start-0 border-end-0 bg-light" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn btn-light border border-start-0 text-muted" type="button" onclick="toggleLoginPassword()" id="togglePasswordBtn">
            <i class="bi bi-eye"></i>
        </button>
    </div>
</div>

            <button class="btn btn-lg w-100 fw-bold text-white shadow-sm mb-3" 
                    style="background-color: #002147; border-radius: 8px; transition: all 0.3s;"
                    onmouseover="this.style.backgroundColor='#003366'" 
                    onmouseout="this.style.backgroundColor='#002147'"
                    onclick="handleLogin()">
                Sign In
            </button>
            
            <p id="loginError" class="text-danger small text-center fw-bold animate__animated animate__headShake" style="display:none;"></p>
            
            <div class="text-center mt-4">
                <small class="text-muted">Authorized Personnel Only</small>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeModalLabel">Employee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="clearForm()"></button>
      </div>
      <div class="modal-body">
        <form>
          <input type="hidden" id="empIndex">
          <div class="mb-3">
            <label for="empId" class="form-label">Employee ID</label>
            <input type="text" class="form-control" id="empId">
          </div>
          <div class="mb-3">
            <label for="empName" class="form-label">Name</label>
            <input type="text" class="form-control" id="empName">
          </div>
          <div class="mb-3">
            <label for="empDept" class="form-label">Department</label>
            <input type="text" class="form-control" id="empDept">
          </div>
          <div class="mb-3">
            <label for="empJoinDate" class="form-label">Join Date</label>
            <input type="date" class="form-control" id="empJoinDate">
          </div>
          <div class="mb-3">
            <label for="empShift" class="form-label">Default Shift</label>
            <select class="form-select" id="empShift">
              <option value="MORNING_8_5">Morning (8AM‚Äì5PM)</option>
              <option value="NIGHT_6_3">Night (6PM‚Äì3AM)</option>
              <option value="NIGHT_9_30_6_30">Night (9:30PM‚Äì6:30AM)</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="empStatus" class="form-label">Status</label>
            <select class="form-select" id="empStatus">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearForm()">Close</button>
        <button type="button" class="btn btn-primary" onclick="saveEmployee()"><i class="bi bi-plus-lg me-1"></i> Save Employee</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="individualYearlyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title px-2">Individual Yearly Performance Audit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3 mb-4 align-items-end">
                    <div class="col-md-5 position-relative">
                        <label class="form-label fw-bold small text-muted text-uppercase">Search Employee</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                            <input type="text" id="individualSearchInput" class="form-control" placeholder="Type name or ID..." onkeyup="filterIndividualSearch()">
                        </div>
                        <div id="individualSearchResults" class="list-group position-absolute w-100 z-3 shadow" style="display:none; max-height: 200px; overflow-y: auto;"></div>
                        <input type="hidden" id="selectedIndividualId">
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label fw-bold small text-muted text-uppercase">Select Year</label>
                        <input type="number" id="individualYearInput" class="form-control" value="2025">
                    </div>

                    <div class="col-md-5">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary d-flex align-items-center justify-content-center gap-2 flex-grow-1" 
                                    style="height: 38px; white-space: nowrap;" 
                                    onclick="generateIndividualYearlyData()">
                                <i class="bi bi-search"></i> Generate Report
                            </button>
                            
                            <button class="btn btn-success d-flex align-items-center justify-content-center gap-2" 
                                    style="height: 38px; white-space: nowrap;" 
                                    onclick="exportIndividualExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Excel
                            </button>
                        </div>
                    </div>
                </div>

                <div id="individualReportContent" style="display:none;">
                    <div class="card border-0 bg-light mb-4">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h4 id="displayEmpName" class="mb-0 fw-bold text-dark"></h4>
                                <span id="displayEmpDept" class="badge bg-secondary-soft text-secondary text-uppercase mt-1"></span>
                            </div>
                            <div class="text-end">
                                <div class="text-muted small fw-bold text-uppercase">Audit Year</div>
                                <span class="badge bg-primary fs-5 shadow-sm" id="displayYearLabel"></span>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive rounded-3 border shadow-sm">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="ps-3">Month</th>
                                    <th class="text-center">Present</th>
                                    <th class="text-center">PL</th>
                                    <th class="text-center">CL</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-center">FL</th>
                                    <th class="text-center">COFF</th>
                                    <th class="text-center">Holidays</th>
                                    <th class="text-end pe-3">NSA Total (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="individualYearlyBody"></tbody>
                            <tfoot class="table-dark border-top-0" id="individualYearlyFooter"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="advancedBulkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-navy text-white py-3" style="background-color: #002147;">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-layers-half me-2" style="color: #FF8C00;"></i>Advanced Bulk Attendance Tool
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-4 bg-light bg-opacity-50">
                <div class="row g-4">
                    
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm" style="border-top: 5px solid #FF8C00 !important;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0 text-navy">Select Employees</h6>
                                    <span id="bulkSelectCount" class="badge rounded-pill" style="background-color: #002147;">0 Selected</span>
                                </div>
                                
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm border-1" id="bulkDeptFilter" onchange="filterBulkEmployeeList()">
                                            <option value="">All Depts</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <input type="text" class="form-control form-control-sm border-1" id="bulkSearchEmp" placeholder="Search..." onkeyup="filterBulkEmployeeList()">
                                    </div>
                                </div>

                                <div class="selected-preview mb-3 p-2 border rounded bg-white" style="min-height: 60px; max-height: 80px; overflow-y: auto;">
                                    <div id="bulkSelectedBadges" class="d-flex flex-wrap gap-1">
                                        <small class="text-muted italic">No employees selected</small>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between gap-2 mb-3">
                                    <button class="btn btn-sm btn-outline-navy flex-grow-1 fw-bold" style="border: 2px solid #002147;" onclick="selectVisibleBulk(true)">
                                        <i class="bi bi-check2-all"></i> Visible
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-grow-1 fw-bold" style="border: 2px solid #dc3545;" onclick="clearAllSelectedEmployees()">
                                        <i class="bi bi-x-circle"></i> Clear
                                    </button>
                                </div>

                                <div id="bulkEmployeeList" class="list-group list-group-flush border rounded overflow-auto mb-2" style="max-height: 252px;">
                                    </div>
                                
                                <div id="bulkPagination" class="d-flex justify-content-center"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="card h-100 border-0 shadow-sm" style="border-top: 5px solid #FF8C00 !important;">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3 text-navy">Select Dates</h6>
                                
                                <ul class="nav nav-pills nav-fill mb-3 bg-light p-1 rounded" id="dateTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active py-1 small fw-bold" data-bs-toggle="pill" data-bs-target="#tabRange">Date Range</button>
    </li>
    <li class="nav-item">
        <button class="nav-link py-1 small fw-bold" data-bs-toggle="pill" data-bs-target="#tabSpecific">Specific Dates</button>
    </li>
</ul>

                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="tabRange">
                                        <div class="p-3 border rounded bg-white">
                                            <div class="row g-3">
                                                <div class="col-6">
                                                    <label class="form-label small fw-bold text-muted">From</label>
                                                    <input type="date" class="form-control" id="bulkDateFrom">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label small fw-bold text-muted">To</label>
                                                    <input type="date" class="form-control" id="bulkDateTo">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="tab-pane fade" id="tabSpecific">
                                        <div class="input-group mb-2">
                                            <input type="date" class="form-control" id="specificDatePicker">
                                            <button class="btn text-white px-3" style="background-color: #002147;" onclick="addSpecificDate()">Add</button>
                                        </div>
                                        
                                        <button class="btn btn-outline-navy btn-sm w-100 mb-2 fw-bold" style="border: 2px solid #002147;" onclick="addMonthNoWknd()">
                                            <i class="bi bi-calendar-check me-1"></i> Month (No Weekends)
                                        </button>
                                        
                                        <div id="specificDateList" class="border p-2 rounded bg-white shadow-inner" style="min-height: 120px; max-height: 160px; overflow-y: auto;"></div>
                                        
                                        <div class="text-end">
                                            <button class="btn btn-link btn-sm text-danger text-decoration-none p-0" onclick="clearAllBulkDates()">Clear All</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card h-100 border-0 shadow-sm" style="border-top: 5px solid #FF8C00 !important;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge me-2" style="background-color: #FF8C00;">3</span>
                                    <h6 class="fw-bold mb-0 text-navy">Attendance Action</h6>
                                </div>
                                
                                <div class="p-3 border rounded bg-white">
                                    <label class="form-label small fw-bold text-muted">Set Status</label>
                                    <select class="form-select form-select-lg mb-4 fw-bold" id="bulkActionType" style="font-size: 0.9rem; border-color: #dee2e6;">
                                        <option value="PRESENT">Mark PRESENT</option>
                                        <option value="PL">Mark PL</option>
                                        <option value="CL">Mark CL</option>
                                        <option value="SL">Mark SL</option>
                                        <option value="FL">Mark FL</option>
                                        <option value="COFF">Mark COFF</option> 
                                        <optgroup label="Shift Override" id="bulkShiftGroup"></optgroup>
                                    </select>
                                    
                                    <div class="d-flex gap-2 p-2 bg-light rounded border-start border-4 border-warning">
                                        <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                        <small class="text-muted" style="font-size: 0.75rem;">Existing data for these dates will be overwritten.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="p-0 border-top">
                <button class="btn w-100 py-3 fw-bold rounded-0 d-flex align-items-center justify-content-center gap-2 fs-5 text-white" 
                        style="background-color: #FF8C00;"
                        onclick="processBulkAttendance()">
                    <i class="bi bi-cloud-upload-fill"></i> PROCESS BULK ATTENDANCE
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkEmployeeModal" tabindex="-1" aria-labelledby="bulkEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEmployeeModalLabel">Bulk Add Employees</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Enter IDs and Names separated by commas. All employees will be assigned the same Department, Join Date, and Shift.</p>
                <div class="mb-3">
                    <label for="bulkEmpIds" class="form-label">Employee IDs (comma separated)</label>
                    <textarea class="form-control" id="bulkEmpIds" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="bulkEmpNames" class="form-label">Employee Names (comma separated)</label>
                    <textarea class="form-control" id="bulkEmpNames" rows="2"></textarea>
                </div>
                <div class="mb-3">
                    <label for="bulkEmpDept" class="form-label">Department</label>
                    <input type="text" class="form-control" id="bulkEmpDept">
                </div>
                <div class="mb-3">
                    <label for="bulkEmpJoinDate" class="form-label">Join Date</label>
                    <input type="date" class="form-control" id="bulkEmpJoinDate">
                </div>
                <div class="mb-3">
                    <label for="bulkEmpShift" class="form-label">Default Shift</label>
                    <select class="form-select" id="bulkEmpShift">
                        <option value="MORNING_8_5">Morning (8AM‚Äì5PM)</option>
                        <option value="NIGHT_6_3">Night (6PM‚Äì3AM)</option>
                        <option value="NIGHT_9_30_6_30">Night (9:30PM‚Äì6:30AM)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveBulkEmployees()">Add Employees</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shiftOverrideModal" tabindex="-1" aria-labelledby="shiftOverrideModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shiftOverrideModalLabel">Override Shift</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Setting custom shift for <strong id="overrideDatesCount">0</strong> selected day(s).</p>
        <label for="overrideShift" class="form-label">Select Shift/NSA Rule</label>
        <select class="form-select" id="overrideShift">
          <option value="MORNING_8_5">Morning (8AM‚Äì5PM)</option>
          <option value="NIGHT_6_3">Night (6PM‚Äì3AM)</option>
          <option value="NIGHT_9_30_6_30">Night (9:30PM‚Äì6:30AM)</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" onclick="markShiftOverride()">Apply Override</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="employeeHistoryModal" tabindex="-1" aria-labelledby="employeeHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeHistoryTitle">Attendance History: Employee Name (ID)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3 g-2">
            <div class="col-md-5">
                <label for="historyFilterDate" class="form-label">Filter by Date (YYYY-MM)</label>
                <input type="text" class="form-control" id="historyFilterDate" oninput="filterEmployeeHistory()" placeholder="e.g., 2024-09">
            </div>
            <div class="col-md-5">
                <label for="historyFilterStatus" class="form-label">Filter by Status</label>
                <select class="form-select" id="historyFilterStatus" onchange="filterEmployeeHistory()">
                    <option value="">All Statuses</option>
                    <option value="PRESENT">PRESENT (Default)</option>
                    <option value="LEAVE">LEAVE</option>
                    <option value="SHIFT_OVERRIDE">Shift Override</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" onclick="document.getElementById('historyFilterDate').value='';document.getElementById('historyFilterStatus').value='';filterEmployeeHistory()">Reset</button>
            </div>
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Details/Shift</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="employeeHistoryBody">
                </tbody>
            </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="monthlyBreakdownModal" tabindex="-1" aria-labelledby="monthlyBreakdownModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="monthlyBreakdownTitle">Monthly Breakdown</h5>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" onclick="exportMonthlyBreakdown()">Export to Excel</button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
            <table class="table table-bordered table-sm monthly-breakdown-table" id="monthlyBreakdownTable">
                <thead id="monthlyBreakdownHeader" class="table-light"></thead>
                <tbody id="monthlyBreakdownBody"></tbody>
                <tfoot id="monthlyBreakdownFooter"></tfoot>
            </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Leave & NSA Tracker</span>
    <div class="ms-auto">
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container-fluid p-4">

  <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management-content" type="button" role="tab">‚öôÔ∏è Management</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance-content" type="button" role="tab">üóìÔ∏è Attendance Calendar</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-content" type="button" role="tab" onclick="loadSummaryTabDefaults()">üìà Reporting & Summary</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="activity-tab" 
        data-bs-toggle="tab" 
        data-bs-target="#activity-content" 
        type="button" 
        role="tab" 
        onclick="loadActivityLogs(); populateManagerFilter();" 
        data-tooltip="View System Audit Trails & Logs">
    üìú Activity Log
</button>
    </li>
</ul>

    <div class="tab-content" id="mainTabsContent">

        <div class="tab-pane fade show active" id="management-content" role="tabpanel" aria-labelledby="management-tab">
            
           <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
    <div class="card-body p-4">
        <div class="d-flex align-items-center mb-4">
            <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
                <i class="bi bi-gear-wide-connected fs-4" style="color: #002147;"></i>
            </div>
            <div>
                <h4 class="mb-0 fw-bold" style="color: #002147;">NSA Rules & Settings</h4>
                <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Night Shift Allowance Configuration</small>
            </div>
        </div>

        <div class="p-3 rounded mb-2" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
            <div id="nsaRulesContainer" class="row g-4">
                </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <button class="btn btn-md text-white fw-bold shadow-sm px-4" 
                    style="background-color: #002147; transition: all 0.3s;" 
                    onclick="saveNsaRules()">
                <i class="bi bi-check2-circle me-2"></i>Save NSA Configuration
            </button>
        </div>
    </div>
</div>

            <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold text-navy mb-0">
                <i class="bi bi-calendar-event me-2 text-orange" style="color: #FF8C00;"></i>Holiday Management
            </h5>
            <span class="badge bg-navy px-3 py-2" id="holidayTotalCount" style="background-color: #002147;">0 Holidays Total</span>
        </div>

        <div class="row g-3 p-3 rounded bg-light border mb-4">
            <div class="col-md-4">
                <label class="form-label small fw-bold text-muted text-uppercase">Holiday Date</label>
                <input type="date" class="form-control border-2" id="holidayDate">
            </div>
            <div class="col-md-5">
                <label class="form-label small fw-bold text-muted text-uppercase">Holiday Name (Optional)</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-pencil-square text-navy"></i></span>
                    <input type="text" class="form-control border-start-0 border-2" id="holidayName" placeholder="e.g., Independence Day">
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn w-100 text-white fw-bold d-flex align-items-center justify-content-center gap-2 shadow-sm" 
                        style="background-color: #002147; height: 38px;" 
                        onclick="addHoliday()">
                    <i class="bi bi-plus-lg"></i> Add Holiday
                </button>
            </div>
        </div>

        <h6 class="fw-bold text-navy mb-3 mt-2 text-uppercase small">Saved Holidays</h6>
        <div class="table-responsive rounded border shadow-sm bg-white mb-3">
            <table class="table table-hover align-middle mb-0">
                <thead style="background-color: #f8f9fa;">
                    <tr>
                        <th class="ps-3 py-3 text-white small fw-bold">DATE</th>
                        <th class="py-3 text-white small fw-bold">HOLIDAY NAME</th>
                        <th class="pe-3 py-3 text-end text-white small fw-bold">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="holidaysList">
                    </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded border">
            <small class="text-muted fw-bold ps-2" id="holidayPageInfo">Showing page 1 of 1</small>
            <nav>
                <ul class="pagination pagination-sm mb-0 gap-1">
    <li class="page-item" id="prevHolidayLi">
        <button class="page-link rounded border-0 text-navy fw-bold shadow-sm" 
                id="prevHolidayBtn"
                onclick="changeHolidayPage(-1)" 
                style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background-color: #ffffff; color: #002147;">
            <i class="bi bi-chevron-left"></i>
        </button>
    </li>

    <li class="page-item active">
        <span class="page-link rounded border-0 shadow-sm fw-bold" 
              id="currentHolidayPage" 
              style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background-color: #FF8C00; border-color: #FF8C00; color: white;">
            1
        </span>
    </li>

    <li class="page-item" id="nextHolidayLi">
        <button class="page-link rounded border-0 text-navy fw-bold shadow-sm" 
                id="nextHolidayBtn"
                onclick="changeHolidayPage(1)" 
                style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background-color: #ffffff; color: #002147;">
            <i class="bi bi-chevron-right"></i>
        </button>
    </li>
</ul>
            </nav>
        </div>
    </div>
</div>
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div class="d-flex align-items-center">
        <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
            <i class="bi bi-people-fill fs-4" style="color: #002147;"></i>
        </div>
        <div>
            <h4 class="mb-0 fw-bold" style="color: #002147;">Employee Management</h4>
            <small class="text-muted fw-bold" id="empTotalCounter">Syncing records...</small>
        </div>
    </div>
    
    <div class="d-flex gap-2 flex-wrap">
        <button class="btn shadow-sm text-white fw-bold px-3" style="background-color: #002147;" data-bs-toggle="modal" data-bs-target="#employeeModal" onclick="clearForm()">
            <i class="bi bi-plus-lg me-1"></i> Add Employee
        </button>

        <button class="btn btn-outline-navy fw-bold" style="border: 2px solid #002147; color: #002147;" data-bs-toggle="modal" data-bs-target="#individualYearlyModal">
            <i class="bi bi-person-badge me-1"></i> Yearly Audit
        </button>
        
        <button class="btn fw-bold text-white shadow-sm" style="background-color: #FF8C00;" onclick="openAdvancedBulkTool()">
            <i class="bi bi-layers-fill me-1"></i> Advanced Bulk Attendance Tool
        </button>

        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle fw-bold shadow-sm" type="button" id="excelDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-file-earmark-excel me-1"></i> Bulk Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2" aria-labelledby="excelDropdown">
                <li><h6 class="dropdown-header small text-uppercase fw-bold text-muted">Import Options</h6></li>
                <li><a class="dropdown-item rounded py-2" href="#" data-bs-toggle="modal" data-bs-target="#bulkEmployeeModal"><i class="bi bi-plus-square me-2 text-primary"></i>Bulk Employee Add</a></li>
                <li><a class="dropdown-item rounded py-2" href="#" onclick="document.getElementById('empExcelFile').click()"><i class="bi bi-cloud-upload me-2 text-success"></i>Import Bulk Excel</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header small text-uppercase fw-bold text-muted">Resources</h6></li>
                <li><a class="dropdown-item rounded py-2" href="#" id="downloadSampleExcel"><i class="bi bi-file-earmark-arrow-down me-2 text-info"></i>Sample Excel</a></li>
            </ul>
        </div>
    </div>
</div>

<input type="file" id="empExcelFile" accept=".xlsx,.xls" style="display:none" onchange="handleExcelUpload(event)">

<div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
    <div class="card-body p-0">
        <div class="p-3 bg-light border-bottom">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <select class="form-select border-2" id="departmentFilter" onchange="filterEmployees()">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 border-2"><i class="bi bi-search text-muted"></i></span>
                        <input class="form-control border-start-0 border-2" id="employeeSearch" placeholder="Search ID or Name..." oninput="filterEmployees()" />
                    </div>
                </div>
                <div class="col-md-5 d-flex justify-content-md-end gap-2">
                    <button class="btn btn-outline-danger btn-sm fw-bold px-3" onclick="deleteSelectedEmployees()">
                        <i class="bi bi-trash me-1"></i> Delete Selected
                    </button>
                    <button class="btn btn-dark btn-sm fw-bold px-3" onclick="deleteAllEmployees()">
    <i class="bi bi-exclamation-triangle me-1"></i> Delete All
</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="employeeTable">
                <thead style="background-color: #002147; color: white;">
                    <tr>
                        <th style="width: 50px;" class="ps-3">
                            <input type="checkbox" class="form-check-input border-2" id="selectAllHeader" onclick="toggleSelectAll(this)">
                        </th>
                        <th>ID</th>
                        <th>NAME</th>
                        <th>DEPARTMENT</th>
                        <th>SHIFT</th>
                        <th>STATUS</th>
                        <th class="text-end pe-4">ACTIONS</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div class="card-footer bg-white border-top py-3">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted fw-bold" id="empPageInfo">Showing 0-0 of 0</small>
            <nav aria-label="Employee Pagination">
                <ul class="pagination pagination-sm mb-0 gap-1" id="employeePagination">
                    </ul>
            </nav>
        </div>
    </div>
</div>
</div> 
       <div class="tab-pane fade" id="attendance-content" role="tabpanel" aria-labelledby="attendance-tab">
    <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-4">
                <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
                    <i class="bi bi-calendar-check-fill fs-4" style="color: #002147;"></i>
                </div>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #002147;">Attendance Management</h4>
                    <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Interactive Monthly Scheduler</small>
                </div>
            </div>

            <div class="p-3 rounded mb-4" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3 position-relative">
                        <label class="form-label small fw-bold text-muted text-uppercase">Employee Search</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-2 border-end-0"><i class="bi bi-person-search"></i></span>
                            <input type="text" class="form-control border-2 border-start-0" id="attendanceSearchInput" placeholder="Name or ID..." oninput="filterAttendanceEmployees()">
                        </div>
                        <input type="hidden" id="attendanceEmployee">
                        <div id="attendanceSearchResults" class="list-group position-absolute w-100 mt-1 shadow search-results-container" style="z-index: 1050; max-height: 200px; overflow-y: auto; display: none;"></div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted text-uppercase">Target Month</label>
                        <div class="input-group border-2">
                            <button class="btn btn-outline-navy border-2 shadow-sm" type="button" onclick="changeMonth(-1)" title="Previous Month"><i class="bi bi-chevron-left"></i></button>
                            <input type="month" class="form-control border-2 text-center fw-bold" id="attendanceMonth" min="2023-01" style="color: #002147;"/>
                            <button class="btn btn-outline-navy border-2 shadow-sm" type="button" onclick="changeMonth(1)" title="Next Month"><i class="bi bi-chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="col-md-6 d-flex gap-2 flex-wrap">
                        <button class="btn fw-bold text-white shadow-sm flex-grow-1" style="background-color: #198754;" onclick="markSelected('PRESENT')">
                            <i class="bi bi-check-circle me-1"></i> Mark Present
                        </button>
                        
                        <div class="dropdown flex-grow-1">
                            <button class="btn fw-bold text-white dropdown-toggle w-100 shadow-sm" style="background-color: #FF8C00;" data-bs-toggle="dropdown">
                                <i class="bi bi-sun me-1"></i> Mark Leave
                            </button>
                            <ul class="dropdown-menu shadow border-0">
                                <li><a class="dropdown-item py-2 fw-bold text-primary" onclick="markSelected('LEAVE','PL')">Paid Leave (PL)</a></li>
                                <li><a class="dropdown-item py-2 fw-bold text-primary" onclick="markSelected('LEAVE','CL')">Casual Leave (CL)</a></li>
                                <li><a class="dropdown-item py-2 fw-bold text-primary" onclick="markSelected('LEAVE','SL')">Sick Leave (SL)</a></li>
                                <li><a class="dropdown-item py-2 fw-bold text-primary" onclick="markSelected('LEAVE','FL')">Festival Leave (FL)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item py-2 fw-bold text-navy" onclick="markSelected('LEAVE','COFF')">Comp. Off (COFF)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-3 pt-3 border-top">
                    <button class="btn btn-sm btn-outline-navy fw-bold" onclick="openShiftOverrideModal()">
                        <i class="bi bi-clock-history me-1"></i> Shift Override
                    </button>
                    <button class="btn btn-sm btn-outline-secondary fw-bold" onclick="clearSelected()">
                        <i class="bi bi-eraser me-1"></i> Clear Selected
                    </button>
                    <div class="ms-auto">
                        <button class="btn btn-sm btn-outline-danger fw-bold" onclick="clearAllForEmployee()">
                            <i class="bi bi-trash3 me-1"></i> Clear Entire Month
                        </button>
                    </div>
                </div>
            </div>

            <div class="calendar-wrapper p-2 rounded border bg-white shadow-inner">
                <div id="calendarHeaders" class="row g-1 text-center mb-2">
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Sun</div>
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Mon</div>
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Tue</div>
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Wed</div>
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Thu</div>
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Fri</div>
                    <div class="col py-2 fw-bold text-muted small text-uppercase">Sat</div>
                </div>
                <div id="calendar" class="row g-1 min-vh-50">
                     <div class="col-12"><div class="alert bg-light border text-center py-5 text-muted">Select an employee and month above to begin marking attendance.</div></div>
                </div>
            </div>
        </div>
    </div>
</div>
        
        <div class="tab-pane fade" id="summary-content" role="tabpanel" aria-labelledby="summary-tab">
            
            <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
    <div class="card-body p-4">
        <div class="d-flex align-items-center mb-4">
            <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
                <i class="bi bi-person-badge-fill fs-4" style="color: #002147;"></i>
            </div>
            <h4 class="mb-0 fw-bold" style="color: #002147;">Employee Monthly Summary</h4>
        </div>

        <div class="row g-3 mb-4 p-3 rounded" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
            <div class="col-md-4 position-relative">
                <label class="form-label small fw-bold text-muted text-uppercase">Search Employee</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-2 border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-2 border-start-0" id="summarySearchInput" placeholder="Name or ID..." oninput="filterSummaryEmployees()">
                </div>
                <input type="hidden" id="summaryEmployee">
                <div id="summarySearchResults" class="list-group position-absolute w-100 mt-1 shadow search-results-container" style="z-index: 1050; max-height: 200px; overflow-y: auto; display: none;"></div>
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Month</label>
                <input type="month" class="form-control border-2" id="summaryMonth">
            </div>
            <div class="col-md-5 d-flex align-items-end gap-2">
                <button class="btn text-white fw-bold shadow-sm" style="background-color: #002147;" onclick="renderEmployeeSummary()">
                    View Summary
                </button>
                <button class="btn btn-outline-secondary fw-bold d-none" id="backSummaryBtn" onclick="hideEmployeeSummary()">Reset</button>
                <button class="btn btn-outline-success fw-bold shadow-sm" onclick="exportEmpSummary()">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> Export
                </button>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-8" id="employeeSummary">
                <div class="alert bg-light border text-center py-4">
                    <i class="bi bi-info-circle d-block fs-2 mb-2 text-muted"></i>
                    Select an employee and month, then click <strong>View Summary</strong>.
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm p-3 text-center h-100" style="background-color: #fcfcfc;">
                    <h6 class="fw-bold text-uppercase small mb-3" style="color: #002147;">Attendance Status</h6>
                    <canvas id="summaryChart" style="max-height: 220px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

           <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #002147 !important;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 fw-bold" style="color: #002147;">All Department Monthly Summary</h4>
            <button class="btn text-white fw-bold shadow-sm" style="background-color: #FF8C00;" onclick="exportDeptSummary()">
                <i class="bi bi-download me-1"></i> Export All Data
            </button>
        </div>

        <div class="table-responsive border rounded">
            <table class="table table-hover align-middle mb-0" id="deptSummaryTable">
                <thead style="background-color: #002147; color: white;">
                    <tr>
                        <th class="ps-3">Employee</th>
                        <th>Department</th>
                        <th class="text-center">Present Days</th>
                        <th class="text-center">M-Shift</th>
                        <th class="text-center">N1-Shift</th>
                        <th class="text-center">N2-Shift</th>
                        <th class="text-end pe-3">Total NSA (‚Çπ)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            Data will appear after clicking <strong>View Summary</strong> above.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white border-top py-3">
        <nav>
            <ul class="pagination pagination-sm justify-content-center mb-0 gap-1" id="deptSummaryPagination"></ul>
        </nav>
    </div>
</div>

            <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div class="d-flex align-items-center">
                <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
                    <i class="bi bi-pie-chart-fill fs-4" style="color: #002147;"></i>
                </div>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #002147;">Department Monthly Breakdown</h4>
                    <small class="text-muted fw-bold">Departmental Attendance & NSA Analysis</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary fw-bold d-none" id="backDeptSummaryBtn" onclick="hideDeptSummary()">
                    <i class="bi bi-arrow-left me-1"></i> Reset
                </button>
                <button class="btn fw-bold text-white shadow-sm" style="background-color: #002147;" onclick="exportDeptMonthlySummary()">
                    <i class="bi bi-file-earmark-excel me-1"></i> Export Breakdown
                </button>
            </div>
        </div>

        <div class="p-3 rounded mb-4" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-uppercase text-muted">Select Department</label>
                    <select class="form-select border-2" id="deptSummaryDept">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-uppercase text-muted">Target Month</label>
                    <input type="month" class="form-control border-2" id="deptSummaryMonth">
                </div>
                <div class="col-md-4">
                    <button class="btn fw-bold text-white w-100 shadow-sm" style="background-color: #FF8C00;" onclick="renderDeptMonthlySummary()">
                        <i class="bi bi-search me-1"></i> Generate Breakdown
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive border rounded">
            <table class="table table-hover align-middle mb-0" id="deptMonthlySummary">
                <thead style="background-color: #002147; color: white;">
                    <tr>
                        <th class="ps-3">Employee</th>
                        <th class="text-center">P</th>
                        <th class="text-center">M-Shift</th>
                        <th class="text-center">N1-Shift</th>
                        <th class="text-center">N2-Shift</th>
                        <th class="text-center">PL</th>
                        <th class="text-center">CL</th>
                        <th class="text-center">SL</th>
                        <th class="text-center">FL</th>
                        <th class="text-center" style="background-color: rgba(255,255,255,0.1);">COFF</th>
                        <th class="text-center" style="background-color: rgba(255,255,255,0.1);">FH</th>
                        <th class="text-end pe-3">Total NSA (‚Çπ)</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    <tr>
                        <td colspan="12" class="text-center py-5 text-muted">
                            <i class="bi bi-calendar2-check d-block fs-1 mb-2 opacity-25"></i>
                            Select filters above to view monthly data.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="card-footer bg-white border-top py-3">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted fw-bold" id="deptPageInfo">Showing 0 of 0 records</small>
            <nav>
                <ul class="pagination pagination-sm mb-0 gap-1" id="deptMonthlySummaryPagination">
                    </ul>
            </nav>
        </div>
    </div>
</div>

     <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #FF8C00 !important;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div class="d-flex align-items-center">
                <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
                    <i class="bi bi-calendar-range-fill fs-4" style="color: #002147;"></i>
                </div>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #002147;">Yearly Summary</h4>
                    <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Annual Performance Overview</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn fw-bold shadow-sm px-3" onclick="viewMonthlyBreakdown()" 
                        style="border: 2px solid #002147; color: #002147; background-color: white;">
                    <i class="bi bi-table me-2"></i> Monthly Table
                </button>
                <button class="btn text-white fw-bold shadow-sm" style="background-color: #002147;" onclick="exportYearlySummary()">
                    <i class="bi bi-file-earmark-excel me-1"></i> Export
                </button>
            </div>
        </div>

        <div class="p-3 rounded mb-4" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted text-uppercase">Year</label>
                    <input type="number" class="form-control border-2" id="yearlySummaryYear" value="2025">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted text-uppercase">Department</label>
                    <select class="form-select border-2" id="yearlySummaryDept">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex gap-2">
                    <button class="btn fw-bold text-white w-100 shadow-sm" style="background-color: #FF8C00;" onclick="renderYearlySummary(1)">
                        Generate Summary
                    </button>
                    <button class="btn btn-outline-secondary fw-bold px-4 d-none" id="backYearlyBtn" onclick="resetYearlySummary()">
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive border rounded" id="yearlySummaryResults">
            <table class="table table-hover align-middle mb-0">
                <thead style="background-color: #002147; color: white;">
                    <tr>
                        <th class="ps-3">Employee</th>
                        <th>Department</th>
                        <th class="text-center">P</th>
                        <th class="text-center">M-Shift</th>
                        <th class="text-center">N1-Shift</th>
                        <th class="text-center">N2-Shift</th>
                        <th class="text-center">PL</th>
                        <th class="text-center">CL</th>
                        <th class="text-center">SL</th>
                        <th class="text-center">FL</th>
                        <th class="text-end pe-3">Total NSA (‚Çπ)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="11" class="text-center py-5 text-muted">Select filters and click Generate.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white border-top py-3">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted fw-bold" id="yearlyPageInfo">Showing 0 of 0 records</small>
            <nav><ul class="pagination pagination-sm mb-0 gap-1" id="yearlySummaryPagination"></ul></nav>
        </div>
    </div>
</div>

        </div> 
    
<div class="tab-pane fade" id="activity-content" role="tabpanel" aria-labelledby="activity-tab">
    <div class="card border-0 shadow-sm mb-4" style="border-top: 5px solid #002147 !important;">
        <div class="card-body p-4">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <div class="p-2 rounded me-3" style="background-color: rgba(0, 33, 71, 0.1);">
                        <i class="bi bi-clock-history fs-4" style="color: #002147;"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold" style="color: #002147;">System Activity Log</h4>
                        <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Audit Trail & Security Tracking</small>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <span class="input-group-text bg-white border-navy text-navy"><i class="bi bi-person-filter"></i></span>
                        <select id="logUserFilter" class="form-select border-navy fw-bold text-navy" onchange="filterLogsByUser(this.value)">
    <option value="">All Managers</option>
    </select>
                    </div>
                    <button class="btn btn-navy btn-sm fw-bold px-3 shadow-sm" onclick="refreshActivityLogs()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-responsive border rounded bg-white mb-3" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="sticky-top bg-white" style="z-index: 10;">
                        <tr style="background-color: #002147; color: white;">
                            <th class="ps-3 py-3" style="width: 200px;">Timestamp</th>
                            <th style="width: 180px;">Action Event</th>
                            <th>Details & Impact</th>
                            <th class="pe-3" style="width: 150px;">Performed By</th>
                        </tr>
                    </thead>
                    <tbody id="activityLogTableBody">
                        </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded border shadow-sm">
                <div class="small fw-bold text-navy text-uppercase">
                    <i class="bi bi-info-circle me-1"></i> Showing activity history
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0 gap-2">
                        <li class="page-item">
                            <button class="page-link rounded border-0 shadow-sm fw-bold text-navy" 
                                    id="prevLogBtn" onclick="changeLogPage(-1)" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </li>
                        <li class="page-item active">
                            <span class="page-link rounded border-0 shadow-sm fw-bold text-white" 
                                  id="currentLogPage" 
                                  style="background-color: #FF8C00; border-color: #FF8C00; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                                1
                            </span>
                        </li>
                        <li class="page-item">
                            <button class="page-link rounded border-0 shadow-sm fw-bold text-navy" 
                                    id="nextLogBtn" onclick="changeLogPage(1)" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
</div>
 </div>



<script>
    // --- FIREBASE INITIALIZATION & CONFIGURATION ---
    // !!! IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIGURATION !!!
 const firebaseConfig = {
    apiKey: "AIzaSyD-n4_2uM2yqVrQ2Z58qS4lg_EJD4bTAVI",
    authDomain: "leave-nsa-tracker.firebaseapp.com",
    projectId: "leave-nsa-tracker",
    storageBucket: "leave-nsa-tracker.firebasestorage.app",
    messagingSenderId: "851559376572",
    appId: "1:851559376572:web:978a86f0468ccc535c52b9"
  };

    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore();

    
    // ---------------------------------------------
// This stores the employee data so we don't have to keep asking the internet

let currentLoggedInUser = "Unknown User";

// Firebase Auth Observer
firebase.auth().onAuthStateChanged((user) => {
    const loginOverlay = document.getElementById('loginOverlay');
    
    if (user) {
        // Hide the login screen and show the dashboard
        currentLoggedInUser = user.email; 
        if (loginOverlay) loginOverlay.style.display = 'none';
        console.log("Logged in as:", currentLoggedInUser);
    } else {
        // Show the login screen overlay
        if (loginOverlay) {
            loginOverlay.style.display = 'flex'; // Uses flex to center the box
        }
    }
});

  let bulkEmployeeCache = [];
    document.getElementById('downloadSampleExcel').addEventListener('click', () => {
  // Sample employee data
  const data = [
    { ID: 'E001', Name: 'John Doe', Department: 'Customer Support', JoinDate: '2024-01-15', Shift: 'MORNING_8_5', Status: 'Active' },
    { ID: 'E002', Name: 'Jane Smith', Department: 'Customer Support', JoinDate: '2023-10-01', Shift: 'NIGHT_6_3', Status: 'Active' },
    { ID: 'E003', Name: 'Mike Johnson', Department: 'IT', JoinDate: '2024-03-01', Shift: 'MORNING_8_5', Status: 'Active' },
    { ID: 'E004', Name: 'Sarah Williams', Department: 'HR', JoinDate: '2024-06-20', Shift: 'NIGHT_9_30_6_30', Status: 'Active' },
    { ID: 'E005', Name: 'Alice Brown', Department: 'IT', JoinDate: '2023-01-01', Shift: 'MORNING_8_5', Status: 'Active' }
  ];

  // Convert JSON to worksheet
  const ws = XLSX.utils.json_to_sheet(data);

  // Create workbook and append worksheet
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Employees');

  // Save workbook as Excel file
  XLSX.writeFile(wb, 'Sample_Employees.xlsx');
});

// --- AUTHENTICATION & INITIALIZATION ---

// --- AUTHENTICATION & AUTO-LOAD LOGIC ---

/**
 * NEW WRAPPER FUNCTION
 * This organizes all your data loading so it happens in the right order.
 */
/**
 * This function is the ONLY thing allowed to load data on startup.
 */
async function initializeSystemData() {
    try {
        console.log("üîÑ Starting Data Sequence...");

        // 1. Fetch from DB into your global cache
        // Ensure this fills whatever variable 'renderEmployees' uses
        const data = await getEmployeesFromDB(); 
        console.log("üì¶ Data Fetched:", data ? data.length : 0, "employees found.");

        // 2. Populate Dropdowns and Rules
        await renderHolidaysList(); 
        await renderNsaRules(); 
        await populateDepartmentFilter();
        await populateDeptDropdown('deptSummaryDept');
        await populateDeptDropdown('yearlySummaryDept');
        
        // 3. Initialize and Force Render
        await initAttendance();  
        
        // This is the specific call that makes employees appear on the dashboard
        if (typeof renderEmployees === "function") {
            console.log("üé® Drawing Dashboard...");
            await renderEmployees(); 
        }

        console.log("üöÄ Dashboard Ready!");
    } catch (error) {
        // If you see this in console, your Firestore Rules are likely the issue
        console.error("‚õî Initialization Blocked:", error.message);
    }
}

// --- SECURE AUTHENTICATION CONTROLLER ---

// --- CENTRAL AUTH CONTROLLER ---
firebase.auth().onAuthStateChanged(async (user) => {
    const loginOverlay = document.getElementById('loginOverlay');
    
    if (user) {
        console.log("‚úÖ Auth Success:", user.email);
        if(loginOverlay) loginOverlay.style.display = 'none';
        
        // Small delay to ensure Firestore token is fully ready
        setTimeout(async () => {
            await initializeSystemData();
        }, 300);

    } else {
        console.log("‚ùå No User Logged In");
        if(loginOverlay) loginOverlay.style.display = 'flex';
    }
});

/**
 * Loads all initial data and refreshes the UI after successful login
 */
async function startSecureSession() {
    try {
        // Fetch employees from Firestore
        await getEmployeesFromDB(); 
        
        // IMPORTANT: Call your table rendering function here 
        // so the data appears immediately without a refresh.
        if (typeof renderEmployeeTable === "function") {
            renderEmployeeTable(); 
        }
        
        console.log("Dashboard fully loaded.");
    } catch (error) {
        // If an error still happens here, it's likely a rule issue, not a timing issue
        console.error("Session start error:", error);
    }
}

function resetYearlySummary() {
    // 1. Reset Filters to default
    document.getElementById('yearlySummaryYear').value = new Date().getFullYear();
    document.getElementById('yearlySummaryDept').value = "";
    
    // 2. Clear Table
    const tbody = document.querySelector('#yearlySummaryResults tbody');
    tbody.innerHTML = '<tr><td colspan="11" class="text-center py-5 text-muted">Select filters and click Generate.</td></tr>';
    
    // 3. Reset Pagination and Info
    document.getElementById('yearlySummaryPagination').innerHTML = '';
    document.getElementById('yearlyPageInfo').innerText = 'Showing 0 of 0 records';
    
    // 4. Hide Reset Button
    document.getElementById('backYearlyBtn').classList.add('d-none');
    
    yearlySummaryPage = 1;
}
/**
 * Handles the Login button click
 */
function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');

    firebase.auth().signInWithEmailAndPassword(email, pass)
        .then(() => {
            console.log("Login successful!");
            // The onAuthStateChanged above will notice the change and run startSecureSession()
        })
        .catch((error) => {
            console.error("Login failed:", error.code);
            if(errorEl) {
                errorEl.textContent = "Invalid credentials. Please try again.";
                errorEl.style.display = 'block';
            }
        });
}

/**
 * Handles the Logout button click
 */
function logout() {
    if(confirm("Are you sure you want to logout?")) {
        bulkEmployeeCache = []; 
        firebase.auth().signOut().then(() => {
            console.log("Signed out successfully");
            // No need for window.location.href here!
        });
    }
}
/*********************
 * CONSTANTS
 *********************/
const EMPLOYEES_COLLECTION = 'employees';
const ATTENDANCE_COLLECTION = 'attendance';
const SETTINGS_COLLECTION = 'settings';
const HOLIDAYS_DOC_ID = 'holidays_list';
const NSA_RULES_DOC_ID = 'nsa_rules';

const ROWS_PER_PAGE = 5;
const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
const DAY_NAMES = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]; 
// Default NSA Rules
const DEFAULT_NSA_RULES = { 
    MORNING_8_5: { name: 'Morning (8AM‚Äì5PM)', amount: 0 }, 
    NIGHT_6_3: { name: 'Night (6PM‚Äì3AM)', amount: 350 }, 
    NIGHT_9_30_6_30: { name: 'Night (9:30PM‚Äì6:30AM)', amount: 400 } 
};
const SHIFT_KEYS = ['MORNING_8_5', 'NIGHT_6_3', 'NIGHT_9_30_6_30']; // Ordered for reports

// Helper to get short display code for shifts
function getShiftDisplayCode(shiftKey) {
    if (shiftKey === 'MORNING_8_5') return 'Morning shift (8am‚Äì5pm)';
    if (shiftKey === 'NIGHT_6_3') return 'Night shift (6pm‚Äì3am)';
    if (shiftKey === 'NIGHT_9_30_6_30') return 'Night shift (9:30pm‚Äì6:30am)';
    return 'SC';
}


let selectedDates = [];
let currentPage = 1; // For Employee Management table
let currentHistoryEmpId = null; // For Employee History View
let summaryChartInstance = null; // To hold the Chart.js instance

// Summary Pagination States
let deptSummaryPage = 1;
let deptMonthlySummaryPage = 1;

let bulkSelectedEmpIds = new Set();
let bulkSpecificDates = [];

let currentBulkPage = 1;      // Added for pagination
const itemsPerPage = 8;       // Added for pagination

// Initialize Bulk Modal
async function openAdvancedBulkTool() {
    // 1. Reset selection states
    bulkSelectedEmpIds.clear();
    bulkSpecificDates = [];
    currentBulkPage = 1; // Reset to page 1 on open
    
    // 2. Clear UI elements in the modal
    const badges = document.getElementById('bulkSelectedBadges');
    const specificList = document.getElementById('specificDateList');
    if(badges) badges.innerHTML = '<span class="text-muted">No employees selected</span>';
    if(specificList) specificList.innerHTML = '';
    
    document.getElementById('bulkSearchEmp').value = '';
    updateBulkCount();
    
    // 3. Populate fresh data
    await populateDeptDropdown('bulkDeptFilter');
    
    // Cache employees once to make the search bar instant
    bulkEmployeeCache = await getEmployeesFromDB();
    
    const nsaRules = await getNsaRulesFromDB();
    const shiftGroup = document.getElementById('bulkShiftGroup');
    if(shiftGroup) {
        shiftGroup.innerHTML = '';
        for(const key in nsaRules) {
            const opt = document.createElement('option');
            opt.value = `SHIFT_${key}`;
            opt.textContent = `Shift: ${nsaRules[key].name}`;
            shiftGroup.appendChild(opt);
        }
    }
    
    await filterBulkEmployeeList();

    // 4. Handle Modal Instance correctly
    const modalElement = document.getElementById('advancedBulkModal');
    let modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (!modalInstance) {
        modalInstance = new bootstrap.Modal(modalElement);
    }
    modalInstance.show();
}

// Logic to keep selection persistent while searching (Optimized with Cache & Pagination)
async function filterBulkEmployeeList() {
    const dept = document.getElementById('bulkDeptFilter').value;
    const search = document.getElementById('bulkSearchEmp').value.toLowerCase();
    const listContainer = document.getElementById('bulkEmployeeList');
    
    // Step A: Filter logic
    const filtered = bulkEmployeeCache.filter(emp => {
        const nameMatch = emp.name.toLowerCase().includes(search);
        const idMatch = emp.id.toString().toLowerCase().includes(search);
        const deptMatch = !dept || emp.department === dept;
        return emp.status === 'Active' && deptMatch && (nameMatch || idMatch);
    });

    // Step B: Pagination Logic
    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    if (currentBulkPage > totalPages) currentBulkPage = 1;

    const start = (currentBulkPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedItems = filtered.slice(start, end);

    // Step C: Render List
    listContainer.innerHTML = paginatedItems.map(emp => {
        const isChecked = bulkSelectedEmpIds.has(emp.id.toString()) ? 'checked' : '';
        return `
            <div class="list-group-item py-1 d-flex align-items-center">
                <input class="form-check-input me-2 bulk-emp-check" type="checkbox" 
                       value="${emp.id}" data-name="${emp.name}" 
                       onchange="toggleBulkEmpSelection(this)" ${isChecked}>
                <small>${emp.name} <span class="text-muted">(ID: ${emp.id})</span></small>
            </div>
        `;
    }).join('');

    // Step D: Render Pagination UI
    renderPaginationControls(totalPages);
}

// Helper for Pagination Controls
function renderPaginationControls(totalPages) {
    let controls = document.getElementById('bulkPagination');
    if (!controls) {
        controls = document.createElement('div');
        controls.id = 'bulkPagination';
        controls.className = 'd-flex justify-content-center mt-2 gap-2';
        document.getElementById('bulkEmployeeList').after(controls);
    }

    if (totalPages <= 1) {
        controls.innerHTML = '';
        return;
    }

    controls.innerHTML = `
        <button class="btn btn-sm btn-outline-dark" ${currentBulkPage === 1 ? 'disabled' : ''} 
                onclick="changeBulkPage(-1)">Prev</button>
        <span class="small align-self-center" style="margin: 5px;">Page ${currentBulkPage} of ${totalPages}</span>
        <button class="btn btn-sm btn-outline-dark" ${currentBulkPage === totalPages ? 'disabled' : ''} 
                onclick="changeBulkPage(1)">Next</button>
    `;
}

// Helper to Change Page
function changeBulkPage(step) {
    currentBulkPage += step;
    filterBulkEmployeeList();
}

/**
 * 1. Handles the checkbox click in the list
 */
function toggleBulkEmpSelection(checkbox) {
    const id = checkbox.value.toString();
    if (checkbox.checked) {
        bulkSelectedEmpIds.add(id);
    } else {
        bulkSelectedEmpIds.delete(id);
    }
    updateBulkCount();
    renderSelectedBadges();
}

/**
 * 2. Renders the yellow badges with the X button
 */
function renderSelectedBadges() {
    const container = document.getElementById('bulkSelectedBadges');
    if (bulkSelectedEmpIds.size === 0) {
        container.innerHTML = '<span class="text-muted">No employees selected</span>';
        return;
    }

    container.innerHTML = Array.from(bulkSelectedEmpIds).map(id => {
        // Find employee in cache by ID to handle duplicates
        const emp = bulkEmployeeCache.find(e => e.id.toString() === id.toString());
        const displayName = emp ? emp.name : id;
        
        return `
            <span class="badge bg-warning text-dark me-1 mb-1 p-2 d-inline-flex align-items-center">
                ${displayName} (${id})
                <i class="bi bi-x-circle ms-2 cursor-pointer text-danger" 
                   style="font-size: 1rem;" 
                   onclick="removeBulkEmployee('${id}')"></i>
            </span>`;
    }).join('');
}

function toggleLoginPassword() {
    const passwordInput = document.getElementById('loginPassword');
    const toggleBtn = document.getElementById('togglePasswordBtn');
    const icon = toggleBtn.querySelector('i');

    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
    }
}
/**
 * 3. Removes a specific employee (syncs with checkboxes)
 */
function removeBulkEmployee(id) {
    // Remove from data
    bulkSelectedEmpIds.delete(id.toString());
    
    // Physically uncheck the box in the list if it is visible
    const checkbox = document.querySelector(`.bulk-emp-check[value="${id}"]`);
    if (checkbox) checkbox.checked = false;
    
    updateBulkCount();
    renderSelectedBadges();
}

/**
 * 4. Resets everything (The "Clear All" logic)
 */
function clearAllSelectedEmployees() {
    // Clear the Set
    bulkSelectedEmpIds.clear();
    
    // Uncheck every checkbox visible on the current screen
    const allChecks = document.querySelectorAll('.bulk-emp-check');
    allChecks.forEach(cb => {
        cb.checked = false;
    });
    
    updateBulkCount();
    renderSelectedBadges();
}

/**
 * 5. Updates the count label
 */
function updateBulkCount() {
    const label = document.getElementById('bulkSelectCount');
    if (label) {
        label.textContent = `${bulkSelectedEmpIds.size} total selected`;
    }
}

// --- ENHANCED DATE HELPERS ---

function addSpecificDate() {
    const dateInput = document.getElementById('specificDatePicker');
    const date = dateInput.value;
    if(date && !bulkSpecificDates.includes(date)) {
        bulkSpecificDates.push(date);
        bulkSpecificDates.sort(); // Keep dates in order
        renderSpecificDates();
        dateInput.value = ''; // Reset input
    }
}

// Shortcut: Adds all non-weekend dates for the currently selected month in the dashboard
function addMonthNoWknd() {
    const dashMonth = document.getElementById('attendanceMonth').value; // e.g. "2025-12"
    if(!dashMonth) return alert("Please select a month in the main dashboard first.");
    
    const [year, month] = dashMonth.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate();

    for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(year, month - 1, d);
        const day = dateObj.getDay();
        const dateStr = `${dashMonth}-${String(d).padStart(2, '0')}`;
        
        // Skip Sat (6) and Sun (0)
        if (day !== 0 && day !== 6 && !bulkSpecificDates.includes(dateStr)) {
            bulkSpecificDates.push(dateStr);
        }
    }
    renderSpecificDates();
}

function removeSpecificDate(dateToRemove) {
    bulkSpecificDates = bulkSpecificDates.filter(d => d !== dateToRemove);
    renderSpecificDates();
}

function clearAllBulkDates() {
    bulkSpecificDates = [];
    renderSpecificDates();
}

function renderSpecificDates() {
    const container = document.getElementById('specificDateList');
    // Generates the dark blocks with "X" as per screenshot
    container.innerHTML = bulkSpecificDates.map(d => `
        <div class="d-inline-flex align-items-center bg-dark text-white rounded p-1 px-2 me-2 mb-2" style="font-size: 0.85rem;">
            ${d}
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.5rem;" 
                    onclick="removeSpecificDate('${d}')"></button>
        </div>
    `).join('');
}

// "Select Visible" helper for mass selection
function selectVisibleBulk(check) {
    const visibleChecks = document.querySelectorAll('#bulkEmployeeList .bulk-emp-check');
    visibleChecks.forEach(cb => {
        cb.checked = check;
        toggleBulkEmpSelection(cb);
    });
}

// The Final Firebase Batch Processing
async function processBulkAttendance() {
    if (bulkSelectedEmpIds.size === 0) return alert('Select at least one employee');
    
    let datesToProcess = [];
    const activeTab = document.querySelector('#dateTab .active').getAttribute('data-bs-target');
    
    // 1. Gather Dates
    if (activeTab === '#tabRange') {
        const start = document.getElementById('bulkDateFrom').value;
        const end = document.getElementById('bulkDateTo').value;
        if(!start || !end) return alert('Select date range');
        
        let curr = new Date(start);
        const last = new Date(end);
        while(curr <= last) {
            datesToProcess.push(curr.toISOString().split('T')[0]);
            curr.setDate(curr.getDate() + 1);
        }
    } else {
        if(bulkSpecificDates.length === 0) return alert('Add specific dates');
        datesToProcess = bulkSpecificDates;
    }

    const action = document.getElementById('bulkActionType').value;
    const batch = db.batch();
    
    // 2. Process Records
    bulkSelectedEmpIds.forEach(empId => {
        datesToProcess.forEach(date => {
            const recordKey = `${empId}_${date}`;
            const ref = db.collection(ATTENDANCE_COLLECTION).doc(recordKey);
            
            let record = { 
                empId, 
                date, 
                docId: recordKey,
                customShift: null,
                leaveType: null
            };
            
            // Handle Shift Overrides
            if (action.startsWith('SHIFT_')) {
                record.status = 'PRESENT';
                record.customShift = action.replace('SHIFT_', '');
            } 
            // Handle Leaves (Added COFF here)
            else if (['PL','CL','SL','FL','COFF'].includes(action)) {
                record.status = 'LEAVE';
                record.leaveType = action;
            } 
            // Handle Regular Presence (Works for weekends too)
            else {
                record.status = 'PRESENT';
                record.leaveType = null;
                record.customShift = null;
            }
            
            batch.set(ref, record);
        });
    });

    // 3. Commit and Refresh
    try {
        await batch.commit();
        alert('Bulk processing complete!');
        
        // Cleanup UI
        bulkSpecificDates = []; 
        if(document.getElementById('specificDateList')) {
            document.getElementById('specificDateList').innerHTML = '';
        }
        
        bootstrap.Modal.getInstance(document.getElementById('advancedBulkModal')).hide();
        
        // Refresh the calendar and summary views
        if (typeof renderCalendar === "function") renderCalendar();
        
    } catch(e) {
        console.error("Bulk Processing Error: ", e);
        alert('Bulk update failed. Please check console for details.');
    }
}


async function logActivity(actionType, details, targetId = null) {
    try {
        const logEntry = {
            timestamp: new Date().toISOString(),
            action: actionType,
            details: details,
            targetId: targetId,
            performedBy: currentLoggedInUser, // <--- Dynamic from Firebase Auth
            platform: "DealerOn Dashboard"
        };

        await db.collection("Activity_Logs").add(logEntry);
    } catch (error) {
        console.error("Audit Log Error:", error);
    }
}

function getBadgeColor(action) {
    if (action.includes('DELETE')) return 'bg-danger';
    if (action.includes('UPDATE') || action.includes('SAVE')) return 'bg-warning text-dark';
    if (action.includes('SUCCESS')) return 'bg-success';
    return 'bg-info text-dark';
}

let lastVisibleLog = null; // Track the last document for pagination

let currentLogPage = 1;
let logPageStack = []; 
let lastLogDoc = null;
const LOGS_PER_PAGE = 10;
let currentFilterUser = ""; // Tracks if we are filtering by a specific manager

async function loadActivityLogs(direction = 0) {
    const tbody = document.getElementById('activityLogTableBody');
    const nextBtn = document.getElementById('nextLogBtn');
    const prevBtn = document.getElementById('prevLogBtn');

    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm me-2 text-navy"></div> Fetching logs...</td></tr>';

    try {
        // 1. Initialize query on the collection
        let query = db.collection("Activity_Logs");

        // 2. APPLY FILTER FIRST (Critical for query performance)
        // This handles sbsanket87@gmail.com or other manager emails
        if (currentFilterUser && currentFilterUser !== "") {
            query = query.where("performedBy", "==", currentFilterUser);
        }

        // 3. APPLY SORTING SECOND
        query = query.orderBy("timestamp", "desc");

        // 4. Set limit for pagination
        query = query.limit(LOGS_PER_PAGE);

        // 5. Navigation/Pagination Logic
        if (direction === 1 && lastLogDoc) {
            query = query.startAfter(lastLogDoc);
        } else if (direction === -1 && logPageStack.length > 1) {
            logPageStack.pop(); 
            const prevPageFirstDoc = logPageStack[logPageStack.length - 1];
            query = query.startAt(prevPageFirstDoc);
        }

        const snapshot = await query.get();

        if (snapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted">No activity records found for ${currentFilterUser || 'All Managers'}.</td></tr>`;
            if (nextBtn) nextBtn.disabled = true;
            return;
        }

        if (direction !== -1) {
            logPageStack.push(snapshot.docs[0]);
        }

        tbody.innerHTML = '';
        lastLogDoc = snapshot.docs[snapshot.docs.length - 1];

        snapshot.forEach(doc => {
            const log = doc.data();
            const date = new Date(log.timestamp).toLocaleString('en-IN');
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-3 small fw-bold text-muted">${date}</td>
                <td><span class="badge rounded-pill px-3 py-2 ${getBadgeColor(log.action)}">${log.action}</span></td>
                <td class="small">${log.details}</td>
                <td class="fw-bold text-navy pe-3"><i class="bi bi-person-circle me-1"></i> ${log.performedBy}</td>
            `;
            tbody.appendChild(tr);
        });

        // Update UI Controls
        document.getElementById('currentLogPage').innerText = currentLogPage;
        if (prevBtn) prevBtn.disabled = (currentLogPage === 1);
        if (nextBtn) nextBtn.disabled = (snapshot.size < LOGS_PER_PAGE);
        
        if (prevBtn) prevBtn.style.opacity = prevBtn.disabled ? "0.4" : "1";
        if (nextBtn) nextBtn.style.opacity = nextBtn.disabled ? "0.4" : "1";

    } catch (error) {
        // This is where you will see the index error in your console
        console.error("Audit log load error:", error);
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-danger">Error fetching activity history. Please check browser console for index link.</td></tr>';
    }
}

// Function to handle the Filter change
/**
 * Filters the activity table based on the selected Manager's Email.
 * @param {string} userEmail - The email address from the dropdown.
 */
function filterLogsByUser(userEmail) {
    // 1. Clean the input: ensure it's a string and trimmed
    // This prevents errors if there are hidden spaces in the dropdown values
    const selectedUser = userEmail ? userEmail.trim() : "";

    // 2. Set the global filter variable
    currentFilterUser = selectedUser;

    // 3. Reset Pagination State 
    // Important: Resetting these ensures we start from page 1 of the new filter
    currentLogPage = 1;
    logPageStack = [];
    lastLogDoc = null;

    // 4. Update the UI to show a loading state
    const tbody = document.getElementById('activityLogTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-5">
                    <div class="spinner-border spinner-border-sm text-navy me-2"></div>
                    Loading logs for ${selectedUser || 'All Managers'}...
                </td>
            </tr>`;
    }

    // 5. Trigger the database fetch
    // loadActivityLogs(0) will now use the updated 'currentFilterUser' in its query
    loadActivityLogs(0); 
}

function changeLogPage(step) {
    currentLogPage += step;
    loadActivityLogs(step);
}

function refreshActivityLogs() {
    currentLogPage = 1;
    logPageStack = [];
    lastLogDoc = null;
    loadActivityLogs(0);
}

function renderLoadMoreLogs(hasMore) {
    let loadMoreRow = document.getElementById('loadMoreLogsRow');
    if (loadMoreRow) loadMoreRow.remove();

    if (hasMore) {
        const tbody = document.getElementById('activityLogTableBody');
        const tr = document.createElement('tr');
        tr.id = 'loadMoreLogsRow';
        tr.innerHTML = `
            <td colspan="4" class="text-center py-3 bg-light">
                <button class="btn btn-sm btn-outline-navy fw-bold" onclick="loadActivityLogs(true)">
                    Load Older Activity...
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    }
}
/*********************
 * FIREBASE ASYNC CRUD FUNCTIONS (REPLACING LOCAL STORAGE)
 *********************/

// EMPLOYEES
/**
 * HIGH-PERFORMANCE EMPLOYEE FETCHING
 * Logic: Checks local memory first. If empty, fetches from DB once and stores it.
 */
async function getEmployeesFromDB() {
    // 1. MEMORY CHECK: Return immediately if we already have the data
    // This makes tab switching (Attendance -> Summary) instant.
    if (bulkEmployeeCache && bulkEmployeeCache.length > 0) {
        return bulkEmployeeCache;
    }

    // 2. DATABASE FETCH: Only happens if cache is null or empty
    try {
        const snapshot = await db.collection(EMPLOYEES_COLLECTION).get();
        
        if (snapshot.empty) {
            console.warn("Firestore: No employees found.");
            bulkEmployeeCache = []; 
            return [];
        }

        // 3. CACHE HYDRATION: Store data with ID mapped correctly
        bulkEmployeeCache = snapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));

        console.log(`Cache Hydrated: ${bulkEmployeeCache.length} employees loaded.`);
        return bulkEmployeeCache;

    } catch (error) {
        // 4. FAIL-SAFE: Return empty array to prevent .filter() or .map() crashes
        console.error("Critical: Database fetch failed:", error.message);
        return []; 
    }
}
async function saveEmployeeToDB(employee, isNew) {
    try {
        await db.collection(EMPLOYEES_COLLECTION).doc(employee.id).set(employee, { merge: !isNew });
        return true;
    } catch (error) {
        console.error("Error saving employee:", error);
        alert("Error saving employee. Check console for details.");
        return false;
    }
}
async function deleteEmployeeFromDB(id) {
    try {
        const batch = db.batch();
        const targetId = String(id).trim(); // Ensure no hidden spaces

        // 1. Fetch all attendance records specifically by the 'empId' field
        const snapshot = await db.collection('attendance')
            .where('empId', '==', targetId)
            .get();

        // 2. Add found records to the batch
        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });

        // 3. Delete the employee document itself
        const empRef = db.collection('employees').doc(targetId);
        batch.delete(empRef);

        // 4. Execute and wait for confirmation
        await batch.commit();

        // 5. CRITICAL: Force a small delay to ensure Firestore global indexes sync
        await new Promise(resolve => setTimeout(resolve, 800));
        
        return true;
    } catch (error) {
        console.error("Deep Clean failed:", error);
        return false;
    }
}
// Helper to get employee by ID (now async)
async function getEmployeeById(id) { 
    const employees = await getEmployeesFromDB();
    return employees.find(e => e.id === id); 
}

// ATTENDANCE
async function getAttendanceFromDB(empId = null, month = null) {
    try {
        let query = db.collection(ATTENDANCE_COLLECTION);
        if (empId) {
            query = query.where('empId', '==', empId);
        }
        // Firestore doesn't support startsWith on date strings, but we can filter after fetching for simplicity here.
        const snapshot = await query.get();
        let records = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));

        if (month) {
            records = records.filter(r => r.date.startsWith(month));
        }

        return records;

    } catch (error) {
        console.error("Error fetching attendance:", error);
        return [];
    }
}
async function saveAttendanceToDB(record, docId = null) {
    try {
        if (docId) {
            await db.collection(ATTENDANCE_COLLECTION).doc(docId).set(record);
        } else {
             // Use composite key for unique attendance record: empId_date
            const recordKey = `${record.empId}_${record.date}`;
            await db.collection(ATTENDANCE_COLLECTION).doc(recordKey).set(record);
        }
        return true;
    } catch (error) {
        console.error("Error saving attendance:", error);
        return false;
    }
}
async function deleteAttendanceRecordFromDB(docId) {
    try {
        await db.collection(ATTENDANCE_COLLECTION).doc(docId).delete();
        return true;
    } catch (error) {
        console.error("Error deleting attendance:", error);
        return false;
    }
}
async function deleteEmployeeAttendanceByDateRangeFromDB(empId, month) {
    try {
        const records = await getAttendanceFromDB(empId, month);
        const batch = db.batch();
        records.forEach(record => {
            batch.delete(db.collection(ATTENDANCE_COLLECTION).doc(record.docId));
        });
        await batch.commit();
        return true;
    } catch (error) {
        console.error("Error deleting bulk attendance:", error);
        return false;
    }
}

// NSA RULES
async function getNsaRulesFromDB() {
    try {
        const doc = await db.collection(SETTINGS_COLLECTION).doc(NSA_RULES_DOC_ID).get();
        const storedRules = doc.exists ? doc.data().rules : {};

        // Merge stored rules with defaults to ensure all keys exist
        const mergedRules = { ...DEFAULT_NSA_RULES };
        for (const key in DEFAULT_NSA_RULES) {
            if (storedRules[key] && !isNaN(storedRules[key].amount)) {
                mergedRules[key].amount = storedRules[key].amount;
                mergedRules[key].name = storedRules[key].name; // Ensure name is preserved
            }
        }
        return mergedRules;
    } catch (error) {
        console.error("Error fetching NSA rules:", error);
        return DEFAULT_NSA_RULES;
    }
}
async function saveNsaRulesToDB(rules) {
    try {
        // We add a 'lastUpdated' field to keep a record of when rates were changed
        await db.collection(SETTINGS_COLLECTION).doc(NSA_RULES_DOC_ID).set({ 
            rules: rules,
            lastUpdated: new Date().toISOString(),
            updatedBy: "Admin" // Optional: track who made the change
        });
        
        console.log("NSA Rules successfully synced to Database.");
        return true;
    } catch (error) {
        // Log detailed error for debugging
        console.error("Critical Error: Unable to save NSA rules to Firestore:", error);
        return false;
    }
}

// HOLIDAYS
async function getHolidaysFromDB() {
    try {
        const doc = await db.collection(SETTINGS_COLLECTION).doc(HOLIDAYS_DOC_ID).get();
        const holidays = doc.exists ? doc.data().list : [];
        return holidays.sort((a, b) => a.date.localeCompare(b.date));
    } catch (error) {
        console.error("Error fetching holidays:", error);
        return [];
    }
}
async function saveHolidaysToDB(holidays) {
    try {
        await db.collection(SETTINGS_COLLECTION).doc(HOLIDAYS_DOC_ID).set({ list: holidays });
        return true;
    } catch (error) {
        console.error("Error saving holidays:", error);
        return false;
    }
}

/*********************
 * NSA RULE MANAGEMENT
 *********************/

async function renderNsaRules() {
    const container = document.getElementById('nsaRulesContainer');
    container.innerHTML = '';
    const rules = await getNsaRulesFromDB();

    for (const key in rules) {
        const rule = rules[key];
        const col = document.createElement('div');
        col.className = 'col-md-4';
        col.innerHTML = `
            <label class="form-label">${rule.name}</label>
            <div class="input-group">
                <span class="input-group-text">‚Çπ</span>
                <input type="number" class="form-control" id="nsa_${key}" value="${rule.amount}" min="0">
            </div>
        `;
        container.appendChild(col);
    }
}

async function saveNsaRules() {
    const saveBtn = document.querySelector('button[onclick="saveNsaRules()"]');
    const originalContent = saveBtn.innerHTML;
    const newRules = {};
    const defaultRules = DEFAULT_NSA_RULES; 

    // 1. Show Branded Loading State
    saveBtn.disabled = true;
    saveBtn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Syncing Rules...`;

    // 2. Data Collection Logic
    for (const key in defaultRules) {
        const input = document.getElementById(`nsa_${key}`);
        if (input) {
            const amount = parseInt(input.value) || 0;
            newRules[key] = {
                name: defaultRules[key].name, 
                amount: Math.max(0, amount) 
            };
        }
    }

    // 3. Database Execution
    const isSaved = await saveNsaRulesToDB(newRules);

    if (isSaved) {
        // 4. Success State Feedback (DealerOn Success Green)
        saveBtn.style.backgroundColor = "#198754"; 
        saveBtn.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>Rules Applied Successfully`;

        // Refresh UI (Optional: only if rules change calculations on current view)
        const searchVal = document.getElementById('employeeSearch')?.value || "";
        await renderEmployees(currentPage, searchVal);

        // Reset button after 2.5 seconds
        setTimeout(() => {
            saveBtn.disabled = false;
            saveBtn.style.backgroundColor = "#002147"; // Back to Navy
            saveBtn.innerHTML = originalContent;
        }, 2500);

    } else {
        // 5. Error State Feedback
        saveBtn.classList.replace('btn-primary', 'btn-danger');
        saveBtn.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>Save Failed`;
        
        setTimeout(() => {
            saveBtn.disabled = false;
            saveBtn.classList.replace('btn-danger', 'btn-primary');
            saveBtn.innerHTML = originalContent;
        }, 3000);
    }
}

/*********************
 * HOLIDAY MANAGEMENT
 *********************/

async function addHoliday() {
    const date = document.getElementById('holidayDate').value;
    const name = document.getElementById('holidayName').value.trim();

    if (!date) {
        alert('Please select a date.');
        return;
    }

    let holidays = await getHolidaysFromDB();

    if (holidays.some(h => h.date === date)) {
        alert(`Holiday for ${date} already exists.`);
        return;
    }

    holidays.push({ date, name });
    
    if (await saveHolidaysToDB(holidays)) {
        document.getElementById('holidayDate').value = '';
        document.getElementById('holidayName').value = '';
        
        await renderHolidaysList();
        await renderCalendar(); 
        alert(`Holiday added for ${date}.`);
    } else {
        alert('Failed to add holiday.');
    }
}

async function deleteHoliday(dateToDelete) {
    if (!confirm(`Are you sure you want to delete the holiday on ${dateToDelete}?`)) return;

    let holidays = (await getHolidaysFromDB()).filter(h => h.date !== dateToDelete);
    
    if (await saveHolidaysToDB(holidays)) {
        await renderHolidaysList();
        await renderCalendar(); 
        alert(`Holiday on ${dateToDelete} deleted.`);
    } else {
        alert('Failed to delete holiday.');
    }
}

let holidayCurrentPage = 1;
const holidayItemsPerPage = 4;

async function renderHolidaysList() {
    const listContainer = document.getElementById('holidaysList');
    const pageInfo = document.getElementById('holidayPageInfo');
    const totalBadge = document.getElementById('holidayTotalCount');
    const currentPageLabel = document.getElementById('currentHolidayPage');

    // Show loading state
    listContainer.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Loading holidays...</td></tr>';
    
    // Fetch data
    const holidays = await getHolidaysFromDB();

    // 1. Sort by date (ascending)
    holidays.sort((a, b) => new Date(a.date) - new Date(b.date));

    const totalItems = holidays.length;
    const totalPages = Math.ceil(totalItems / holidayItemsPerPage) || 1;
    
    // 2. Bound current page
    if (holidayCurrentPage > totalPages) holidayCurrentPage = totalPages;
    if (holidayCurrentPage < 1) holidayCurrentPage = 1;

    // 3. Calculate pagination slice
    const start = (holidayCurrentPage - 1) * holidayItemsPerPage;
    const end = start + holidayItemsPerPage;
    const paginatedItems = holidays.slice(start, end);

    // 4. Update Header and Footer UI
    if (totalBadge) totalBadge.innerText = `${totalItems} Holidays Total`;
    if (pageInfo) pageInfo.innerText = totalItems > 0 
        ? `Showing ${start + 1}-${Math.min(end, totalItems)} of ${totalItems}`
        : "No holidays found";
    if (currentPageLabel) currentPageLabel.innerText = holidayCurrentPage;

    // 5. Render rows
    listContainer.innerHTML = '';
    
    if (paginatedItems.length === 0) {
        listContainer.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-muted italic">No holidays added yet.</td></tr>';
        return;
    }

    paginatedItems.forEach(holiday => {
        const tr = document.createElement('tr');
        // Added styling to match the premium DealerOn look
        tr.innerHTML = `
            <td class="ps-3 fw-bold" style="color: #002147;">${holiday.date}</td>
            <td>
                <span class="badge bg-light text-dark border fw-normal py-2 px-3">
                    ${holiday.name || 'Public Holiday'}
                </span>
            </td>
            <td class="pe-3 text-end">
                <button class="btn btn-sm btn-outline-danger border-0" 
                        title="Delete Holiday"
                        onclick="deleteHoliday('${holiday.date}')">
                    <i class="bi bi-trash3"></i>
                </button>
            </td>
        `;
        listContainer.appendChild(tr);
    });
}

/**
 * Pagination Controller
 * @param {number} direction - 1 for next, -1 for previous
 */
function changeHolidayPage(direction) {
    holidayCurrentPage += direction;
    renderHolidaysList();
}


/*********************
 * DEPARTMENT FILTER & HELPERS
 *********************/
async function populateDepartmentFilter(){
  const select = document.getElementById('departmentFilter');
  if(!select) return;

  const employees = await getEmployeesFromDB();
  const departments = [...new Set(
    employees.map(e => e.department).filter(Boolean)
  )];

  select.innerHTML = '<option value="">All Departments</option>';
  departments.forEach(dep=>{
    const opt = document.createElement('option');
    opt.value = dep;
    opt.textContent = dep;
    select.appendChild(opt);
  });
}

async function populateDeptDropdown(selectId) {
  const select = document.getElementById(selectId);
  if (!select) return;
  select.innerHTML = '<option value="">All Departments</option>';
  
  const employees = await getEmployeesFromDB();
  const departments = [...new Set(employees.map(e => e.department).filter(Boolean))];
  
  departments.forEach(dep=>{
    const opt = document.createElement('option');
    opt.value = dep;
    opt.textContent = dep;
    select.appendChild(opt);
  });
}


// Returns all working days (Mon-Fri EXCLUDING HOLIDAYS) in a given year and month
async function getWorkingDays(year, month) {
  const allHolidays = (await getHolidaysFromDB()).map(h => h.date); 
  const daysInMonth = new Date(year, month, 0).getDate(); 
  const workingDays = [];
  
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month - 1, d); 
    const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const day = date.getDay(); 
    
    const isWeekend = (day === 0 || day === 6); 
    const isHoliday = allHolidays.includes(dateStr);
    
    if (!isWeekend && !isHoliday) { 
      workingDays.push(dateStr);
    }
  }
  return workingDays;
}

// Returns all working days (Mon-Fri EXCLUDING HOLIDAYS) in a given year
async function getAllWorkingDaysInYear(year) {
  const allHolidays = (await getHolidaysFromDB()).map(h => h.date); 
  const workingDays = {};
  
  for (let m = 1; m <= 12; m++) {
    const monthKey = String(m).padStart(2, '0');
    workingDays[monthKey] = [];
    const daysInMonth = new Date(year, m, 0).getDate();
    
    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(year, m - 1, d); 
      const dateStr = `${year}-${monthKey}-${String(d).padStart(2,'0')}`;
      const day = date.getDay(); 
      
      const isWeekend = (day === 0 || day === 6); 
      const isHoliday = allHolidays.includes(dateStr);
      
      if (!isWeekend && !isHoliday) { 
        workingDays[monthKey].push(dateStr);
      }
    }
  }
  return workingDays;
}

// Function to determine NSA per day, considering shift override
async function getDailyNsaInfo(emp, date) {
    const nsaRules = await getNsaRulesFromDB();
    // Fetch individual record for the date
    const recordKey = `${emp.id}_${date}`;
    const recordDoc = await db.collection(ATTENDANCE_COLLECTION).doc(recordKey).get();
    const records = recordDoc.exists ? recordDoc.data() : null;
    
    // Check for shift override in the attendance record
    if (records && records.customShift) {
        const shiftKey = records.customShift;
        return { 
            shift: shiftKey, 
            amount: nsaRules[shiftKey]?.amount || 0,
            isOverride: true
        };
    }
    
    // Use employee's default shift
    const defaultShift = emp.shift;
    return {
        shift: defaultShift,
        amount: nsaRules[defaultShift]?.amount || 0,
        isOverride: false
    };
}


/*********************
 * PAGINATION HELPERS
 *********************/
function renderSummaryPagination(containerId, totalPages, currentPage, renderFn, pageVarName, params='') {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  
  if (totalPages <= 1) return; 

  // Helper to construct the function call string
  const getCall = (pageNum) => {
    return params 
      ? `${pageVarName} = ${pageNum}; ${renderFn}(${params}); return false;`
      : `${pageVarName} = ${pageNum}; ${renderFn}(${pageNum}); return false;`;
  };

  // --- 1. PREVIOUS ARROW ---
  const prevLi = document.createElement('li');
  const isFirst = currentPage === 1;
  prevLi.className = `page-item ${isFirst ? 'disabled' : ''} ms-1`;
  prevLi.innerHTML = `
    <a class="page-link shadow-sm fw-bold rounded border-0" 
       href="#" 
       onclick="${!isFirst ? getCall(currentPage - 1) : 'return false;'}"
       style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background-color: #ffffff; color: #002147; border: 1px solid #dee2e6 !important; opacity: ${isFirst ? '0.5' : '1'};">
       <i class="bi bi-chevron-left"></i>
    </a>`;
  container.appendChild(prevLi);

  // --- 2. NUMBERED PAGES ---
  for (let i = 1; i <= totalPages; i++) {
    const isActive = i === currentPage;
    const li = document.createElement('li');
    li.className = `page-item ${isActive ? 'active' : ''} ms-1`;
    
    li.innerHTML = `
      <a class="page-link shadow-sm fw-bold rounded border-0" 
         href="#" 
         onclick="${getCall(i)}"
         style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
         ${isActive 
            ? 'background-color: #FF8C00 !important; color: white !important;' 
            : 'background-color: #ffffff; color: #002147; border: 1px solid #dee2e6 !important;'
         }">
         ${i}
      </a>`;
    container.appendChild(li);
  }

  // --- 3. NEXT ARROW ---
  const nextLi = document.createElement('li');
  const isLast = currentPage === totalPages;
  nextLi.className = `page-item ${isLast ? 'disabled' : ''} ms-1`;
  nextLi.innerHTML = `
    <a class="page-link shadow-sm fw-bold rounded border-0" 
       href="#" 
       onclick="${!isLast ? getCall(currentPage + 1) : 'return false;'}"
       style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; background-color: #ffffff; color: #002147; border: 1px solid #dee2e6 !important; opacity: ${isLast ? '0.5' : '1'};">
       <i class="bi bi-chevron-right"></i>
    </a>`;
  container.appendChild(nextLi);
}

function exportIndividualExcel() {
    const empName = document.getElementById('displayEmpName').textContent;
    const year = document.getElementById('individualYearInput').value;
    const table = document.querySelector('#individualYearlyModal table');

    if (!empName || !table || table.querySelector('tbody').children.length === 0) {
        alert("Please generate the report first.");
        return;
    }

    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Convert the HTML table to a worksheet
    // raw: true ensures numbers stay as numbers for calculations
    const ws = XLSX.utils.table_to_sheet(table, { raw: true });

    // Set Column Widths for better readability
    const wscols = [
        { wch: 15 }, // Month
        { wch: 10 }, // Present
        { wch: 6 },  // PL
        { wch: 6 },  // CL
        { wch: 6 },  // SL
        { wch: 6 },  // FL
        { wch: 8 },  // COFF
        { wch: 10 }, // Holidays
        { wch: 15 }  // NSA Total
    ];
    ws['!cols'] = wscols;

    // Add the worksheet to the workbook
    XLSX.utils.book_append_sheet(wb, ws, "Yearly Audit");

    // Save the file
    const fileName = `Yearly_Audit_${empName.replace(/\s+/g, '_')}_${year}.xlsx`;
    XLSX.writeFile(wb, fileName);
}
/*********************
 * EMPLOYEE TABLE
 *********************/
// Add these variables at the top of your script
let selectedEmployeeIds = new Set();

async function renderEmployees(page = currentPage, filter = '') {
    const tbody = document.querySelector('#employeeTable tbody');
    const pageInfo = document.getElementById('empPageInfo');
    const totalCount = document.getElementById('empTotalCounter');
    
    if (!tbody) return; 

    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm me-2" style="color: #002147;"></div>Syncing Records...</td></tr>';
    
    const allEmployees = await getEmployeesFromDB();

    const deptFilter = document.getElementById('departmentFilter')?.value || '';
    const searchTerm = filter.toLowerCase();

    const filtered = allEmployees.filter(emp => {
        const matchesText = (emp.name || "").toLowerCase().includes(searchTerm) || 
                            (emp.id || "").includes(filter);
        const matchesDept = !deptFilter || emp.department === deptFilter;
        return matchesText && matchesDept;
    }).sort((a, b) => (a.id || "").localeCompare(b.id || ""));

    const totalItems = filtered.length;
    const totalPages = Math.ceil(totalItems / ROWS_PER_PAGE) || 1;
    currentPage = Math.min(page, totalPages) || 1;
    const start = (currentPage - 1) * ROWS_PER_PAGE;
    const end = start + ROWS_PER_PAGE;
    const paginated = filtered.slice(start, end);

    if (totalCount) totalCount.innerText = `Total: ${allEmployees.length} Employees`;
    if (pageInfo) pageInfo.innerText = totalItems > 0 
        ? `Showing ${start + 1}-${Math.min(end, totalItems)} of ${totalItems}`
        : "No records found";

    const fragment = document.createDocumentFragment();

    if (paginated.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5"><h5 class="text-muted fw-bold">No Records Found</h5></td></tr>`;
        renderPagination(0);
        return;
    }

    paginated.forEach(emp => {
        const tr = document.createElement('tr');
        tr.className = "align-middle";
        
        const rawShift = (emp.shift || 'N/A').toUpperCase();
        let shiftStyle = 'background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;'; 
        
        if (rawShift.includes('MORNING')) {
            shiftStyle = 'background-color: #FFF3CD; color: #856404; border: 1px solid #FFEEBA;'; 
        } else if (rawShift.includes('NIGHT')) {
            shiftStyle = 'background-color: #E2E3E5; color: #002147; border: 1px solid #D6D8DB;';
        }

        const deptValue = (emp.department || 'Other');
        const statusValue = emp.status || 'Active';
        const isChecked = selectedEmployeeIds.has(emp.id) ? 'checked' : '';

        // ADDED data-label to each <td> for mobile responsiveness
        tr.innerHTML = `
            <td class="ps-3">
                <input type="checkbox" class="form-check-input emp-checkbox border-2" 
                    value="${emp.id}" ${isChecked} onchange="toggleEmpSelect('${emp.id}')">
            </td>
            <td data-label="ID"><span class="fw-bold" style="color: #002147;">${emp.id}</span></td>
            <td data-label="NAME">
                <div class="fw-bold mb-0">${emp.name}</div>
                <small class="text-muted">DealerOn Associate</small>
            </td>
            <td data-label="DEPARTMENT"><span class="badge border bg-light text-dark fw-normal px-3 py-2">${deptValue}</span></td>
            <td data-label="SHIFT"><span class="badge px-3 py-2 fw-bold" style="${shiftStyle}"><i class="bi bi-clock me-1"></i>${rawShift}</span></td>
            <td data-label="STATUS"><span class="badge rounded-pill fw-bold ${statusValue === 'Active' ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'}" style="padding: 0.5em 1em;">‚óè ${statusValue}</span></td>
            <td class="text-end pe-3" data-label="ACTIONS">
                <div class="btn-group shadow-sm bg-white rounded">
                    <button class="btn btn-sm btn-outline-navy border-0 py-2 px-2" style="margin: 2px;" onclick="viewEmployeeHistory('${emp.id}')"><i class="bi bi-clock-history"></i></button>
                    <button class="btn btn-sm btn-outline-navy border-0 py-2 px-2" style="margin: 2px;" onclick="editEmployee('${emp.id}')"><i class="bi bi-pencil-square"></i></button>
                </div>
            </td>`;
        fragment.appendChild(tr);
    });

    tbody.innerHTML = '';
    tbody.appendChild(fragment);
    renderPagination(totalPages);
}
/**
 * Pagination Page Change Handler
 */
function changeEmployeePage(direction) {
    const nextSearch = document.getElementById('employeeSearchInput')?.value || '';
    currentPage += direction;
    renderEmployees(currentPage, nextSearch);
}
// Checkbox Logic
function toggleEmpSelect(id) {
    if (selectedEmployeeIds.has(id)) selectedEmployeeIds.delete(id);
    else selectedEmployeeIds.add(id);
}

function toggleSelectAll(masterCheckbox) {
    // We target the specific class 'emp-checkbox' inside the table body
    const checkboxes = document.querySelectorAll('#employeeTable tbody .emp-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = masterCheckbox.checked;
        if (masterCheckbox.checked) {
            selectedEmployeeIds.add(cb.value);
        } else {
            selectedEmployeeIds.delete(cb.value);
        }
    });
}

function filterEmployees() {
  renderEmployees(1, document.getElementById('employeeSearch').value);
}

function renderPagination(totalPages) {
    const container = document.getElementById('employeePagination');
    if (!container) return;

    container.innerHTML = '';

    // 1. Previous Button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link rounded border-0 fw-bold me-1" 
           href="javascript:void(0)" 
           onclick="handlePageClick(event, ${currentPage - 1})"
           style="color: #002147; background: #f8f9fa;">
           <i class="bi bi-chevron-left"></i>
        </a>`;
    container.appendChild(prevLi);

    // 2. Page Numbers
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        const isActive = i === currentPage;
        
        li.className = `page-item ${isActive ? 'active' : ''}`;
        
        // Inline styles to force DealerOn Orange for Active and Navy for others
        li.innerHTML = `
            <a class="page-link rounded border-0 fw-bold mx-1 shadow-sm" 
               href="javascript:void(0)" 
               onclick="handlePageClick(event, ${i})"
               style="${isActive 
                        ? 'background-color: #FF8C00 !important; color: white; border-color: #FF8C00 !important;' 
                        : 'color: #002147; background: white;'}">
               ${i}
            </a>`;
        
        container.appendChild(li);
    }

    // 3. Next Button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link rounded border-0 fw-bold ms-1" 
           href="javascript:void(0)" 
           onclick="handlePageClick(event, ${currentPage + 1})"
           style="color: #002147; background: #f8f9fa;">
           <i class="bi bi-chevron-right"></i>
        </a>`;
    container.appendChild(nextLi);
}

// Add this helper function to manage the state correctly
function handlePageClick(event, pageNum) {
    if (event) event.preventDefault();
    
    // 1. Update the global variable
    currentPage = pageNum;
    
    // 2. Re-render the table
    renderEmployees();
}

/*********************
 * Bulk EMPLOYEE REMOVE LOGIC
 *********************/

async function deleteSelectedEmployees() {
    if (selectedEmployeeIds.size === 0) return alert("Please select employees to remove.");
    
    const count = selectedEmployeeIds.size;
    if (!confirm(`Are you sure you want to delete ${count} employees and ALL their attendance history?`)) return;

    try {
        // 1. Log the START of the specific deletion
        // We capture the IDs being targeted for the audit trail
        const targetedIds = Array.from(selectedEmployeeIds).join(', ');
        await logActivity("SELECTED_DELETE_START", `Initiated deletion for ${count} employees. IDs: ${targetedIds}`);

        console.log(`Starting bulk deletion for ${count} employees...`);

        for (const id of selectedEmployeeIds) {
            await deleteEmployeeFromDB(id);
            
            if (typeof allAttendance !== 'undefined') {
                allAttendance = allAttendance.filter(rec => rec.empId !== id);
            }
        }

        // --- UI SYNC BLOCK ---
        selectedEmployeeIds.clear();
        bulkEmployeeCache = []; 
        
        await renderEmployees(); 
        await populateDepartmentFilter();
        await populateAttendanceEmployees(); 
        await populateDeptDropdown('deptSummaryDept');
        await populateDeptDropdown('yearlySummaryDept');
        
        const selectAllHeader = document.getElementById('selectAllHeader');
        if (selectAllHeader) selectAllHeader.checked = false;

        renderCalendar();

        // 2. Log SUCCESSFUL completion
        await logActivity("SELECTED_DELETE_SUCCESS", `Successfully removed ${count} selected employees and their history.`);

        alert("Selected employees and all their history removed successfully.");

        // Optional: Refresh the Activity Log table if it's visible on the current page
        if (document.getElementById('activityLogTableBody')) {
            loadActivityLogs();
        }

    } catch (e) {
        // 3. Log the FAILURE
        await logActivity("SELECTED_DELETE_FAILED", `Error deleting ${count} employees: ${e.message}`);
        
        console.error("Error deleting selected employees:", e);
        alert("Error deleting employees. Check console for details.");
    }
}

let lastDeletedSnapshot = []; // Global variable to hold backup data

async function deleteAllEmployees() {
    const all = await getEmployeesFromDB();
    if (all.length === 0) return alert("No employees found to delete.");

    // 1. Double Confirmation
    const firstCheck = confirm("‚ö†Ô∏è DANGER: This will remove EVERY employee AND their attendance history. Proceed?");
    if (!firstCheck) return;

    const finalCheck = prompt("Final Safety Check: Type 'DELETE' to confirm wiping the database:");
    if (finalCheck !== "DELETE") return alert("Deletion cancelled.");

    try {
        const count = all.length;
        
        // --- LOGGING: Start of Wipe ---
        await logActivity("DATABASE_WIPE_START", `Initiated full wipe of ${count} employee records.`);

        // 2. Create the Backup Snapshot
        lastDeletedSnapshot = [...all]; 

        // 3. Backup to 'Settings' collection
        await db.collection("Settings").doc("Last_Backup").set({ 
            employees: lastDeletedSnapshot,
            deletedAt: new Date().toISOString(),
            count: count
        });

        // 4. Perform the Deletion
        for (const emp of all) {
            await deleteEmployeeFromDB(emp.id);
        }

        // 5. Update UI State
        await syncUIAfterDeletion();

        // --- LOGGING: Wipe Success ---
        await logActivity("DATABASE_WIPE_SUCCESS", `Successfully wiped ${count} records and created temporary backup.`);

        // 6. Show the Undo Toast
        const undoToast = document.getElementById('undoToast');
        if (undoToast) {
            undoToast.classList.remove('d-none');
            setTimeout(() => {
                undoToast.classList.add('d-none');
            }, 10000);
        }

    } catch (e) {
        console.error("Error clearing database:", e);
        // --- LOGGING: Wipe Failure ---
        await logActivity("DATABASE_WIPE_FAILED", `Error during wipe: ${e.message}`);
        alert("Failed to clear database.");
    }
}

async function undoDeletion() {
    if (!lastDeletedSnapshot || lastDeletedSnapshot.length === 0) return;

    const undoBtn = document.querySelector('#undoToast button');
    if (undoBtn) {
        undoBtn.disabled = true;
        undoBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    }

    try {
        const count = lastDeletedSnapshot.length;
        
        // --- LOGGING: Start of Restore ---
        await logActivity("RESTORE_START", `Initiated restoration of ${count} employees from backup.`);

        // Loop through backup and re-insert into DB
        for (const emp of lastDeletedSnapshot) {
            await db.collection("Employees").doc(emp.id).set(emp);
        }

        // --- LOGGING: Restore Success ---
        await logActivity("RESTORE_SUCCESS", `Successfully restored ${count} employees to the database.`);

        alert("Undo Successful: All records restored.");
        document.getElementById('undoToast')?.classList.add('d-none');
        
        // Refresh everything
        await renderEmployees();
        await populateAttendanceEmployees();
        renderCalendar();
        
        // Refresh Activity Logs tab if it exists
        if (typeof refreshActivityLogs === 'function') refreshActivityLogs();
        
    } catch (e) {
        console.error("Undo failed:", e);
        // --- LOGGING: Restore Failure ---
        await logActivity("RESTORE_FAILED", `Critical error during restoration: ${e.message}`);
        alert("Failed to restore data fully.");
    } finally {
        if (undoBtn) {
            undoBtn.disabled = false;
            undoBtn.innerText = "Undo";
        }
    }
}

async function syncUIAfterDeletion() {
    bulkEmployeeCache = []; 
    selectedEmployeeIds.clear();
    if (typeof allAttendance !== 'undefined') allAttendance = [];
    
    await renderEmployees();
    await populateDepartmentFilter();
    await populateAttendanceEmployees();
    await populateDeptDropdown('deptSummaryDept');
    await populateDeptDropdown('yearlySummaryDept');

    const selectAllHeader = document.getElementById('selectAllHeader');
    if (selectAllHeader) selectAllHeader.checked = false;

    renderCalendar();
    
    // Auto-refresh the activity log tab after UI sync
    if (typeof refreshActivityLogs === 'function') refreshActivityLogs();
}

/*********************
 * EMPLOYEE MODAL LOGIC
 *********************/
async function saveEmployee(){
  const empIdValue = empId.value.trim();
  const index = empIndex.value;
  const isNew = (index === ''); // Check if we are adding or editing
  
  const emp = {
    id: empIdValue,
    name: empName.value.trim(),
    department: empDept.value.trim(),
    joinDate: empJoinDate.value,
    shift: empShift.value,
    status: empStatus.value
  };
  
  if(!emp.id || !emp.name || !emp.department || !emp.joinDate){ 
    alert('Please fill all required fields, including Join Date.'); 
    return; 
  }
  
  const employees = await getEmployeesFromDB();
  
  // Check for duplicate ID only when adding new employee
  if (isNew && employees.some(e => e.id === emp.id)) {
      alert(`Employee ID ${emp.id} already exists.`);
      return;
  }
  
  // Save to Firestore
  if(await saveEmployeeToDB(emp, isNew)) {
    
    // --- LOGGING BLOCK ---
    const actionType = isNew ? "ADD_EMPLOYEE" : "UPDATE_EMPLOYEE";
    const actionDetails = isNew 
        ? `Added new employee: ${emp.name} (ID: ${emp.id}) to ${emp.department}`
        : `Updated details for ${emp.name} (ID: ${emp.id})`;
        
    await logActivity(actionType, actionDetails, emp.id);
    // --------------------

    bootstrap.Modal.getInstance(employeeModal).hide();
    clearForm();
    bulkEmployeeCache = [];
    
    // Sync all UI components
    await renderEmployees();
    await populateDepartmentFilter(); 
    await populateDeptDropdown('deptSummaryDept'); 
    await populateDeptDropdown('yearlySummaryDept');
    await populateAttendanceEmployees(); // Added to ensure attendance list stays synced

    // Refresh Activity Log tab if it's currently open
    if (typeof refreshActivityLogs === 'function') refreshActivityLogs();
  }
}

async function saveBulkEmployees() {
  const ids = document.getElementById('bulkEmpIds').value.split(',').map(v=>v.trim()).filter(Boolean);
  const names = document.getElementById('bulkEmpNames').value.split(',').map(v=>v.trim()).filter(Boolean);
  const joinDate = document.getElementById('bulkEmpJoinDate').value; 
  const dept = document.getElementById('bulkEmpDept').value.trim();
  const shift = document.getElementById('bulkEmpShift').value;

  if(ids.length === 0 || names.length === 0 || !dept || !joinDate){ 
    alert("Please fill all fields properly, including Join Date.");
    return;
  }

  if(ids.length !== names.length){
    alert("Number of IDs and Names must match.");
    return;
  }

  const employees = await getEmployeesFromDB();
  let newEmployeesCount = 0;
  const batch = db.batch();
  let addedNames = []; // For logging

  for(let i=0; i<ids.length; i++){
    const empId = ids[i];
    if (!employees.some(e => e.id === empId)) {
        const newEmployee = {
            id: empId,
            name: names[i],
            department: dept,
            joinDate: joinDate, 
            shift: shift,
            status: 'Active'
        };
        batch.set(db.collection(EMPLOYEES_COLLECTION).doc(empId), newEmployee);
        newEmployeesCount++;
        addedNames.push(names[i]);
    }
  }

  try {
      if (newEmployeesCount > 0) {
          await batch.commit();
          
          // --- LOGGING: Bulk Add Success ---
          await logActivity(
            "BULK_ADD_EMPLOYEE", 
            `Successfully added ${newEmployeesCount} employees to ${dept} department. Names: ${addedNames.join(', ')}`
          );

          bulkEmployeeCache = []; 
          await renderEmployees();
          await populateDepartmentFilter();
          await populateAttendanceEmployees();
          await populateDeptDropdown('deptSummaryDept'); 
          await populateDeptDropdown('yearlySummaryDept'); 
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('bulkEmployeeModal'));
          if(modal) modal.hide();

          alert(`${newEmployeesCount} new employees added.`);
          
          // Reset fields
          document.getElementById('bulkEmpIds').value='';
          document.getElementById('bulkEmpNames').value='';
          document.getElementById('bulkEmpDept').value='';
          document.getElementById('bulkEmpShift').value='MORNING_8_5';
          document.getElementById('bulkEmpJoinDate').value='';

          // Refresh log tab if active
          if (typeof refreshActivityLogs === 'function') refreshActivityLogs();
      } else {
          alert("No new unique IDs found to add.");
      }
  } catch(e) {
      console.error("Bulk add failed:", e);
      // --- LOGGING: Bulk Add Failure ---
      await logActivity("BULK_ADD_FAILED", `Error during bulk upload: ${e.message}`);
      alert('Failed to add employees in bulk.');
  }
}


async function editEmployee(id){
  const emp = await getEmployeeById(id);
  if (!emp) return;
  
  // Set values to the modal fields
  empIndex.value = id; 
  empId.value = emp.id; 
  empId.readOnly = true; 
  empName.value = emp.name; 
  empDept.value = emp.department;
  empJoinDate.value = emp.joinDate || ''; 
  empShift.value = emp.shift; 
  empStatus.value = emp.status;

  // Visual Cue for the Modal
  document.querySelector('#employeeModalLabel').innerText = `Editing: ${emp.name}`;
  
  new bootstrap.Modal(employeeModal).show();
}

/** * NOTE: Ensure your saveEmployee function (the one triggered by the modal "Save" button) 
 * includes this line:
 * * await logActivity("UPDATE_EMPLOYEE", `Modified details for ${empName.value} (ID: ${empId.value})`, empId.value);
 */
async function deleteEmployee(id) {
    if(!confirm(`PERMANENT ACTION: Delete Employee ${id} and all history?`)) return;
    
    const success = await deleteEmployeeFromDB(id);
    
    if (success) {
        // 1. Clear local memory
        if (typeof allAttendance !== 'undefined') {
            allAttendance = allAttendance.filter(rec => rec.empId !== id);
        }

        // 2. Remove from selection set if it was checked
        selectedEmployeeIds.delete(id);

        // 3. REFRESH EVERYTHING (Matches your Bulk Delete logic)
        await renderEmployees(currentPage); 
        await populateDepartmentFilter();
        await populateAttendanceEmployees(); 
        
        // 4. Reset Select All checkbox state
        const selectAllHeader = document.getElementById('selectAllHeader');
        if (selectAllHeader) selectAllHeader.checked = false;

        // 5. Force UI updates
        if (typeof renderCalendar === 'function') renderCalendar();
        
        alert("Employee and history removed successfully.");
    }
}

function clearForm(){
  empIndex.value=''; 
  empId.value=''; 
  empId.readOnly=false;
  empName.value=''; 
  empDept.value='';
  empJoinDate.value=''; 
  empShift.value='MORNING_8_5'; 
  empStatus.value='Active';
}

/*********************************
 * ATTENDANCE UI (SEARCH LOGIC)
 *********************************/

async function filterAttendanceEmployees() {
  const input = document.getElementById('attendanceSearchInput');
  const resultsContainer = document.getElementById('attendanceSearchResults');
  const filter = input.value.toLowerCase();
  
  document.getElementById('attendanceEmployee').value = '';
  document.getElementById('calendar').innerHTML = '<div class="col"><div class="alert alert-info text-center">Select an employee and a month to view the attendance calendar.</div></div>';


  if (!filter || filter.length < 2) { 
    resultsContainer.style.display = 'none';
    return;
  }

  const allEmployees = await getEmployeesFromDB();
  const employees = allEmployees.filter(emp => 
    emp.status === 'Active' && 
    ((emp.name && emp.name.toLowerCase().includes(filter)) || (emp.id && emp.id.toLowerCase().includes(filter)))
  );

  resultsContainer.innerHTML = '';
  
  if (employees.length > 0) {
    employees.forEach(emp => {
      const item = document.createElement('button');
      item.type = 'button'; 
      item.className = 'list-group-item list-group-item-action search-item';
      item.innerHTML = `<strong>${emp.name}</strong> <small class="text-muted">(${emp.id} - ${emp.department})</small>`;
      item.onclick = () => selectEmployeeForAttendance(emp);
      resultsContainer.appendChild(item);
    });
    resultsContainer.style.display = 'block';
  } else {
    resultsContainer.innerHTML = '<button type="button" class="list-group-item text-muted text-center">No active employees found</button>';
    resultsContainer.style.display = 'block';
  }
}

function selectEmployeeForAttendance(emp) {
  const input = document.getElementById('attendanceSearchInput');
  const hiddenIdInput = document.getElementById('attendanceEmployee');
  const resultsContainer = document.getElementById('attendanceSearchResults');

  input.value = `${emp.name} (${emp.id})`;
  hiddenIdInput.value = emp.id;
  
  resultsContainer.style.display = 'none';
  renderCalendar();
}

async function populateAttendanceEmployees(){
  // No longer needed to populate select list, just resets search state
  const searchInput = document.getElementById('attendanceSearchInput');
  const hiddenIdInput = document.getElementById('attendanceEmployee');
  
  if(searchInput) searchInput.value = '';
  if(hiddenIdInput) hiddenIdInput.value = '';
  const calendar = document.getElementById('calendar');
  if(calendar) calendar.innerHTML = '<div class="col"><div class="alert alert-info text-center">Select an employee and a month to view the attendance calendar.</div></div>'; 
}

async function filterIndividualSearch() {
    const input = document.getElementById('individualSearchInput');
    const container = document.getElementById('individualSearchResults');
    const filter = input.value.toLowerCase();

    if (filter.length < 2) {
        container.style.display = 'none';
        return;
    }

    const employees = await getEmployeesFromDB();
    const matches = employees.filter(e => 
        e.name.toLowerCase().includes(filter) || e.id.toLowerCase().includes(filter)
    );

    container.innerHTML = '';
    matches.forEach(emp => {
        const btn = document.createElement('button');
        btn.className = 'list-group-item list-group-item-action';
        btn.innerHTML = `<strong>${emp.name}</strong> <small>(${emp.id})</small>`;
        btn.onclick = () => {
            document.getElementById('individualSearchInput').value = emp.name;
            document.getElementById('selectedIndividualId').value = emp.id;
            container.style.display = 'none';
        };
        container.appendChild(btn);
    });
    container.style.display = 'block';
}

async function generateIndividualYearlyData() {
    const empId = document.getElementById('selectedIndividualId').value;
    const year = document.getElementById('individualYearInput').value;

    if (!empId) return alert("Please select an employee first.");

    const emp = await getEmployeeById(empId);
    const body = document.getElementById('individualYearlyBody');
    const footer = document.getElementById('individualYearlyFooter');
    
    document.getElementById('individualReportContent').style.display = 'block';
    document.getElementById('displayEmpName').textContent = emp.name;
    document.getElementById('displayEmpDept').textContent = emp.department;
    document.getElementById('displayYearLabel').textContent = `Year: ${year}`;

    body.innerHTML = '<tr><td colspan="9" class="text-center">Calculating yearly data...</td></tr>';

    let yearlyTotals = { p: 0, pl: 0, cl: 0, sl: 0, fl: 0, coff: 0, fh: 0, nsa: 0 };

    body.innerHTML = '';
    for (let m = 1; m <= 12; m++) {
        const monthStr = `${year}-${String(m).padStart(2, '0')}`;
        const data = await getMonthlyReportData(emp, monthStr);

        yearlyTotals.p += data.finalPresentDays;
        yearlyTotals.pl += data.leaves.PL;
        yearlyTotals.cl += data.leaves.CL;
        yearlyTotals.sl += data.leaves.SL;
        yearlyTotals.fl += data.leaves.FL;
        yearlyTotals.coff += data.leaves.COFF;
        yearlyTotals.fh += data.fixedHolidaysCount;
        yearlyTotals.nsa += data.totalNsaAmount;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="fw-bold">${MONTH_NAMES[m-1]}</td>
            <td class="text-center">${data.finalPresentDays}</td>
            <td class="text-center">${data.leaves.PL}</td>
            <td class="text-center">${data.leaves.CL}</td>
            <td class="text-center">${data.leaves.SL}</td>
            <td class="text-center">${data.leaves.FL}</td>
            <td class="text-center">${data.leaves.COFF}</td>
            <td class="text-center text-muted">${data.fixedHolidaysCount}</td>
            <td class="text-end fw-bold">‚Çπ${data.totalNsaAmount.toLocaleString()}</td>
        `;
        body.appendChild(tr);
    }

    footer.innerHTML = `
        <tr>
            <td>YEARLY TOTAL</td>
            <td class="text-center">${yearlyTotals.p}</td>
            <td class="text-center">${yearlyTotals.pl}</td>
            <td class="text-center">${yearlyTotals.cl}</td>
            <td class="text-center">${yearlyTotals.sl}</td>
            <td class="text-center">${yearlyTotals.fl}</td>
            <td class="text-center">${yearlyTotals.coff}</td>
            <td class="text-center">${yearlyTotals.fh}</td>
            <td class="text-end text-warning">‚Çπ${yearlyTotals.nsa.toLocaleString()}</td>
        </tr>
    `;
}

/*********************************
 * SUMMARY UI (SEARCH LOGIC)
 *********************************/

async function filterSummaryEmployees() {
  const input = document.getElementById('summarySearchInput');
  const resultsContainer = document.getElementById('summarySearchResults');
  const filter = input.value.toLowerCase();
  
  document.getElementById('summaryEmployee').value = '';
  document.getElementById('employeeSummary').innerHTML = '<div class="alert alert-info text-center">Select an employee and month, and click \'View Summary\' above.</div>';
  
  if(summaryChartInstance) summaryChartInstance.destroy();


  if (!filter || filter.length < 2) { 
    resultsContainer.style.display = 'none';
    return;
  }

  const allEmployees = await getEmployeesFromDB();
  const employees = allEmployees.filter(emp => 
    emp.status === 'Active' && 
    ((emp.name && emp.name.toLowerCase().includes(filter)) || (emp.id && emp.id.toLowerCase().includes(filter)))
  );

  resultsContainer.innerHTML = '';
  
  if (employees.length > 0) {
    employees.forEach(emp => {
      const item = document.createElement('button');
      item.type = 'button'; 
      item.className = 'list-group-item list-group-item-action search-item';
      item.innerHTML = `<strong>${emp.name}</strong> <small class="text-muted">(${emp.id} - ${emp.department})</small>`;
      item.onclick = () => selectEmployeeForSummary(emp);
      resultsContainer.appendChild(item);
    });
    resultsContainer.style.display = 'block';
  } else {
    resultsContainer.innerHTML = '<button type="button" class="list-group-item text-muted text-center">No active employees found</button>';
    resultsContainer.style.display = 'block';
  }
}

function selectEmployeeForSummary(emp) {
  const input = document.getElementById('summarySearchInput');
  const hiddenIdInput = document.getElementById('summaryEmployee');
  const resultsContainer = document.getElementById('summarySearchResults');

  input.value = `${emp.name} (${emp.id})`;
  hiddenIdInput.value = emp.id;
  
  resultsContainer.style.display = 'none';
}


// Universal click handler to close search results when clicking elsewhere
document.addEventListener('click', function(e) {
  const closeSearchResults = (searchInputId, resultsContainerId) => {
    const input = document.getElementById(searchInputId);
    const container = document.getElementById(resultsContainerId);
    if (input && container && !input.contains(e.target) && !container.contains(e.target)) {
      container.style.display = 'none';
    }
  };
  
  closeSearchResults('attendanceSearchInput', 'attendanceSearchResults');
  closeSearchResults('summarySearchInput', 'summarySearchResults');
});

// Init is now async
async function initAttendance(){
  const monthInput=document.getElementById('attendanceMonth');
  monthInput.value=new Date().toISOString().slice(0,7);
  
  attendanceMonth.addEventListener('change', renderCalendar);
  
  await populateAttendanceEmployees(); 
}


// NEW FUNCTION: Change month on attendance calendar
function changeMonth(direction) {
    const monthInput = document.getElementById('attendanceMonth');
    const currentValue = monthInput.value; // YYYY-MM

    if (!currentValue) {
        monthInput.value = new Date().toISOString().slice(0,7);
        return;
    }

    let [year, month] = currentValue.split('-').map(Number);

    let newMonth = month + direction;
    let newYear = year;

    if (newMonth < 1) {
        newMonth = 12;
        newYear -= 1;
    } else if (newMonth > 12) {
        newMonth = 1;
        newYear += 1;
    }

    const newMonthStr = String(newMonth).padStart(2, '0');
    monthInput.value = `${newYear}-${newMonthStr}`;
    
    renderCalendar();
}


/*********************
 * CALENDAR LOGIC 
 *********************/
async function renderCalendar() {
  selectedDates = [];
  const empId = document.getElementById('attendanceEmployee').value;
  const month = attendanceMonth.value;
  const calendar = document.getElementById('calendar');

  if (!empId || !month) {
    calendar.innerHTML = '<div class="col"><div class="alert alert-info text-center">Select an employee and a month to view the attendance calendar.</div></div>';
    return;
  }

  const emp = await getEmployeeById(empId);
  if (!emp) return;
  const joinDate = emp.joinDate;

  // Fetch all attendance records for this employee for this month in one go
  const allRecords = await getAttendanceFromDB(empId, month);
  const getAttendanceRecord = (date) => {
    const recordKey = `${empId}_${date}`;
    return allRecords.find(r => r.docId === recordKey);
  }

  const [year, m] = month.split('-').map(Number);
  const daysInMonth = new Date(year, m, 0).getDate();
  calendar.innerHTML = '';
  const holidays = (await getHolidaysFromDB()).map(h => h.date);
  const nsaRules = await getNsaRulesFromDB();

  // 1. Calculate offset for the first day of the month
  const firstDayOfMonth = new Date(year, m - 1, 1).getDay(); // 0=Sun, 1=Mon, ..., 6=Sat

  // 2. Add blank cells for padding
  for (let i = 0; i < firstDayOfMonth; i++) {
    const blankCell = document.createElement('div');
    blankCell.className = 'date-cell-container';
    blankCell.innerHTML = '<div class="blank-cell"></div>';
    calendar.appendChild(blankCell);
  }

  // 3. Render days
  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(year, m - 1, d);
    const dayIndex = dateObj.getDay();
    const date = `${month}-${String(d).padStart(2, '0')}`;

    const container = document.createElement('div');
    container.className = 'date-cell-container';

    const cell = document.createElement('div');
    cell.className = 'border rounded p-2 text-center date-cell';

    let badge = '';
    let statusText = '';

    const isWeekend = (dayIndex === 0 || dayIndex === 6);
    const isHoliday = holidays.includes(date);
    const isBeforeJoinDate = date < joinDate;
    const record = getAttendanceRecord(date); // Use the pre-fetched record

    // --- START OF EDITED LOGIC ---
    if (isBeforeJoinDate) {
      cell.classList.add('tbh');
      badge = `<small>TBH</small>`;
      statusText = 'TBH';
    } else if (record) {
      if (record.status === 'LEAVE') {
        cell.classList.add('bg-danger', 'text-white'); // Full block red
        badge = `<span class="fw-bold">${record.leaveType}</span>`;
        statusText = record.leaveType;
      } else if (record.customShift) {
        cell.classList.add('bg-info', 'text-dark'); // Full block blue
        const shiftName = nsaRules[record.customShift]?.name || record.customShift;
        badge = `<small class="fw-bold d-block" style="font-size: 0.7rem;">${shiftName}</small>`;
        statusText = `SC (${record.customShift})`;
      } else if (record.status === 'PRESENT') {
        cell.classList.add('bg-success', 'text-white'); // Full block green
        badge = `<span class="fw-bold">PRESENT</span>`;
        statusText = 'P';
      }
    } else if (isHoliday) {
      cell.classList.add('holiday');
      const holidayName = (await getHolidaysFromDB()).find(h => h.date === date)?.name || 'Holiday';
      badge = `<small class="fw-bold text-dark">${holidayName}</small>`;
      statusText = 'H';
    } else if (isWeekend) {
      cell.classList.add('weekend');
      badge = `<small class="text-muted">WEEKEND</small>`;
      statusText = 'W';
    } else {
      // Default Present if no record and not weekend/holiday/before join
      cell.classList.add('bg-success', 'text-white');
      badge = `<span class="fw-bold">PRESENT</span>`;
      statusText = 'P';
    }
    // --- END OF EDITED LOGIC ---

    cell.setAttribute('data-date', date);
    cell.setAttribute('data-status', statusText);

    cell.innerHTML = `<div class="fw-bold">${d}</div>${badge}`;

    // Only allow selection if not before join date (TBH)
    if (!isBeforeJoinDate) {
      cell.onclick = () => toggleDate(cell, date);
    }

    container.appendChild(cell);
    calendar.appendChild(container);
  }
}

function toggleDate(cell,date){
  const idx=selectedDates.indexOf(date);
  if(idx>-1){ selectedDates.splice(idx,1); cell.classList.remove('selected'); }
  else{ selectedDates.push(date); cell.classList.add('selected'); }
}

async function markSelected(status, leaveType = null) {
  const empId = document.getElementById('attendanceEmployee').value;
  
  // Validation: Ensure employee is selected and dates are picked
  if (!empId || selectedDates.length === 0) { 
    alert('Please select an employee and at least one date on the calendar.'); 
    return; 
  }
  
  const batch = db.batch();
  
  selectedDates.forEach(date => {
    const recordKey = `${empId}_${date}`;
    
    // Construct the record
    let record = {
        empId: empId,
        date: date,
        status: status, // 'PRESENT' or 'LEAVE'
        leaveType: leaveType, // Will be 'PL', 'CL', 'SL', 'FL', or 'COFF'
        customShift: null,
        docId: recordKey
    }; 
    
    // Logic: If marking as PRESENT, ensure leaveType is null.
    // Our updated getMonthlyReportData will now automatically 
    // calculate NSA for these manual 'PRESENT' entries on weekends.
    if (status === 'PRESENT') {
        record.leaveType = null;
        delete record.customShift; 
    }
    
    // Logic: If status is LEAVE, ensure customShift is removed
    if (status === 'LEAVE') {
        delete record.customShift;
    }

    // Set the document in the batch
    batch.set(db.collection(ATTENDANCE_COLLECTION).doc(recordKey), record);
  });

  try {
      await batch.commit();
      
      // Reset selection and refresh UI
      selectedDates = []; 
      await renderCalendar();
      
      // Provide feedback if many dates were marked
      console.log(`Successfully marked ${status} for ${empId}`);
  } catch (e) {
      console.error("Batch save failed:", e);
      alert('Failed to update attendance. Please check your connection.');
  }
}

async function clearSelected(){
  const empId=document.getElementById('attendanceEmployee').value;
  if(!empId||selectedDates.length===0) return;
  
  const batch = db.batch();

  selectedDates.forEach(date=>{
    const recordKey = `${empId}_${date}`;
    batch.delete(db.collection(ATTENDANCE_COLLECTION).doc(recordKey));
  });
  
  selectedDates=[];

  try {
      await batch.commit();
      renderCalendar();
  } catch(e) {
      console.error("Batch clear failed:", e);
      alert('Failed to clear attendance for selected dates.');
  }
}

async function clearAllForEmployee(){
  const empId=document.getElementById('attendanceEmployee').value;
  if(!empId) return;
  
  const month = attendanceMonth.value;
  if(!confirm(`Are you sure you want to clear ALL *manually recorded* attendance records for employee ${empId} for ${month}?`)) return;

  if (await deleteEmployeeAttendanceByDateRangeFromDB(empId, month)) {
      selectedDates=[];
      renderCalendar();
      alert(`Attendance cleared for ${empId} in ${month}.`);
  } else {
      alert('Failed to clear all attendance records.');
  }
}

// ENHANCEMENT 2: Shift Override Logic
function openShiftOverrideModal() {
    if (!document.getElementById('attendanceEmployee').value || selectedDates.length === 0) {
        alert('Select an employee and at least one date.');
        return;
    }
    document.getElementById('overrideDatesCount').textContent = selectedDates.length;
    new bootstrap.Modal(document.getElementById('shiftOverrideModal')).show();
}

async function markShiftOverride() {
    const empId = document.getElementById('attendanceEmployee').value;
    const customShift = document.getElementById('overrideShift').value;
    
    if (!empId || selectedDates.length === 0 || !customShift) { 
        alert('Missing data for shift override.'); 
        return; 
    }
    
    const batch = db.batch();
    
    selectedDates.forEach(date => {
        const recordKey = `${empId}_${date}`;

        const record = {
            empId,
            date,
            status: 'PRESENT', 
            leaveType: null,
            customShift: customShift,
            docId: recordKey
        };
        
        batch.set(db.collection(ATTENDANCE_COLLECTION).doc(recordKey), record);
    });
    
    try {
        await batch.commit();
        bootstrap.Modal.getInstance(document.getElementById('shiftOverrideModal')).hide();
        renderCalendar();
    } catch(e) {
        console.error("Shift override failed:", e);
        alert('Failed to apply shift override.');
    }
}


// 4. Function to populate your <select id="logUserFilter"> dynamically
async function populateManagerFilter() {
    const filterDropdown = document.getElementById('logUserFilter');
    if (!filterDropdown) return;

    try {
        // Fetch logs to find unique managers who have performed actions
        const snapshot = await db.collection("Activity_Logs").get();
        const activeUsers = new Set();
        
        snapshot.forEach(doc => {
            const data = doc.data();
            // This captures the dynamic email addresses you just set up
            if (data.performedBy) {
                activeUsers.add(data.performedBy);
            }
        });

        // Clear and rebuild the dropdown starting with the default option
        filterDropdown.innerHTML = '<option value="">All Managers</option>';
        
        // Convert Set to Array and sort alphabetically for a better UI experience
        const sortedUsers = Array.from(activeUsers).sort();

        sortedUsers.forEach(userEmail => {
            const option = document.createElement('option');
            option.value = userEmail;
            option.innerText = userEmail; // Shows the actual email (e.g., sbsanket87@gmail.com)
            filterDropdown.appendChild(option);
        });
        
        console.log("‚úÖ Manager filter populated with:", sortedUsers);
    } catch (error) {
        console.error("Error populating manager filter:", error);
    }
}

/*********************
 * SUMMARY BACK BUTTONS (RESET)
 *********************/
function loadSummaryTabDefaults() {
    const month = document.getElementById('summaryMonth').value;
    if (month) {
        // Only trigger if a month is already set (i.e., not first load)
        // renderDepartmentSummary(month); // Disabled to prevent spamming DB on tab switch
    }
}

function hideEmployeeSummary(){
  document.getElementById('employeeSummary').innerHTML = '<div class="alert alert-info text-center">Select an employee and month, and click \'View Summary\' above.</div>';
  document.querySelector('#deptSummaryTable tbody').innerHTML = '<tr><td colspan="7" class="text-center text-muted">Summary will appear after clicking \'View Summary\' above.</td></tr>';
  document.getElementById('deptSummaryPagination').innerHTML = '';
  document.getElementById('backSummaryBtn').classList.add('d-none');
  
  document.getElementById('summarySearchInput').value = '';
  document.getElementById('summaryEmployee').value = '';
  
  if(summaryChartInstance) summaryChartInstance.destroy();
}

function hideDeptSummary() {
  document.querySelector('#deptMonthlySummary tbody').innerHTML = '<tr><td colspan="10" class="text-center text-muted">Select a department and month to view breakdown.</td></tr>';
  document.getElementById('deptMonthlySummaryPagination').innerHTML = '';
  document.getElementById('backDeptSummaryBtn').classList.add('d-none');

  document.getElementById('deptSummaryDept').value = '';
  document.getElementById('deptSummaryMonth').value = new Date().toISOString().slice(0,7);
}


/*********************
 * MONTHLY SUMMARY LOGIC
 *********************/
// Persistent cache to store reference data and avoid repeated DB hits
const reportRefCache = {
    nsaRules: null,
    holidays: null,
    holidayDates: null
};

async function getMonthlyReportData(emp, month) {
    const [year, m] = month.split('-').map(Number);
    const daysInMonth = new Date(year, m, 0).getDate();
    
    // Optimized Data Fetching: 
    // Only fetch Rules and Holidays if they aren't already in memory
    const [nsaRules, records, holidays] = await Promise.all([
        reportRefCache.nsaRules || getNsaRulesFromDB(),
        getAttendanceFromDB(emp.id, month), // Attendance is unique to emp, must fetch
        reportRefCache.holidays || getHolidaysFromDB()
    ]);

    // Update Cache for subsequent calls
    if (!reportRefCache.nsaRules) reportRefCache.nsaRules = nsaRules;
    if (!reportRefCache.holidays) {
        reportRefCache.holidays = holidays;
        reportRefCache.holidayDates = holidays.map(h => h.date);
    }

    const holidayDates = reportRefCache.holidayDates;
    let leaves = { PL: 0, CL: 0, SL: 0, FL: 0, COFF: 0 }; 
    let fixedHolidaysCount = 0; 
    let finalPresentDays = 0;
    let totalNsaAmount = 0;
    let shiftBreakdown = { MORNING_8_5: 0, NIGHT_6_3: 0, NIGHT_9_30_6_30: 0 }; 

    // Create a local map for O(1) lookup speed inside the loop
    const recordMap = {};
    records.forEach(r => { recordMap[r.date] = r; });

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        
        // Skip dates before join date
        if (dateStr < emp.joinDate) continue;

        const dateObj = new Date(year, m - 1, d);
        const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
        const isHoliday = holidayDates.includes(dateStr);
        const record = recordMap[dateStr];

        // LOGIC: Manual Attendance or Shift Overrides
        if (record && record.status === 'PRESENT') {
            finalPresentDays++;
            const effectiveShiftKey = record.customShift || emp.shift;
            const nsaAmount = nsaRules[effectiveShiftKey]?.amount || 0;
            totalNsaAmount += nsaAmount;

            if (shiftBreakdown.hasOwnProperty(effectiveShiftKey)) {
                shiftBreakdown[effectiveShiftKey]++;
            }
        } 
        // LOGIC: Automatic Presence for Weekdays
        else if (!isWeekend && !isHoliday && !record) {
            finalPresentDays++;
            const effectiveShiftKey = emp.shift; 
            const nsaAmount = nsaRules[effectiveShiftKey]?.amount || 0;
            totalNsaAmount += nsaAmount;

            if (shiftBreakdown.hasOwnProperty(effectiveShiftKey)) {
                shiftBreakdown[effectiveShiftKey]++;
            }
        }
        // LOGIC: Recorded Leaves
        else if (record && record.status === 'LEAVE') {
            if (leaves.hasOwnProperty(record.leaveType)) {
                leaves[record.leaveType]++;
            }
        }
        // LOGIC: Fixed Holidays
        else if (isHoliday) {
            fixedHolidaysCount++;
        }
    }

    return { 
        leaves, 
        fixedHolidaysCount, 
        finalPresentDays, 
        totalNsaAmount, 
        shiftBreakdown, 
        validWorkingDaysCount: daysInMonth 
    };
}

// Helper to calculate NSA without hitting the database inside a loop
function calculateDailyNsaLocally(emp, date, record, nsaRules) {
    // Priority: 1. Specific record shift, 2. Employee default shift
    const effectiveShiftKey = (record && record.shift) ? record.shift : emp.shift;
    const rule = nsaRules[effectiveShiftKey] || { amount: 0 };
    
    return {
        shift: effectiveShiftKey,
        amount: rule.amount || 0
    };
}


async function renderEmployeeSummary() {
  const empId = document.getElementById('summaryEmployee').value;
  const month = summaryMonth.value;
  if (!empId || !month) {
    alert('Select an employee and month');
    return;
  }

  const emp = await getEmployeeById(empId);
  if (!emp) {
    alert('Employee not found or inactive.');
    return;
  }

  document.getElementById('employeeSummary').innerHTML = '<div class="alert alert-warning text-center">Generating summary...</div>';

  const report = await getMonthlyReportData(emp, month);
  const {
    leaves,
    fixedHolidaysCount,
    finalPresentDays,
    totalNsaAmount,
    shiftBreakdown,
    validWorkingDaysCount
  } = report;

  const nsaRules = await getNsaRulesFromDB();

  // 1. Generate Accurate Shift Breakdown HTML
  let breakdownHtml = '<p class="fw-bold">Present Days Breakdown by Shift:</p><ul class="list-unstyled">';
  let breakdownCount = 0;

  // We iterate through all keys present in the breakdown
  Object.keys(shiftBreakdown).forEach(key => {
    const days = shiftBreakdown[key] || 0;
    if (days > 0) {
      const shiftName = nsaRules[key]?.name || key;
      const nsaPerDay = nsaRules[key]?.amount || 0;
      const totalNsaForThisShift = days * nsaPerDay;

      breakdownHtml += `
                <li class="mb-2 p-2 border-bottom shadow-sm bg-white rounded">
                    <strong>${days} Day(s)</strong> in <span class="text-primary">${shiftName}</span>
                    <small class="text-muted ms-2">(Rate: ‚Çπ${nsaPerDay})</small> 
                    <span class="badge bg-success float-end">NSA: ‚Çπ${totalNsaForThisShift}</span>
                </li>`;
      breakdownCount++;
    }
  });

  if (breakdownCount === 0 && finalPresentDays > 0) {
    breakdownHtml += `<li><span class="text-muted">No specific shift data recorded.</span></li>`;
  }
  breakdownHtml += '</ul>';

  // 2. Render UI Cards
  document.getElementById('employeeSummary').innerHTML = `
 <div class="row g-4">
    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-info shadow-sm">
            <div class="card-body py-3">
                <div class="text-muted small fw-bold text-uppercase mb-1">Total Days</div>
                <div class="h3 mb-0 fw-bold">${validWorkingDaysCount} <small class="text-muted fs-6">Days</small></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-success shadow-sm">
            <div class="card-body py-3">
                <div class="text-muted small fw-bold text-uppercase mb-1">Actual Present</div>
                <div class="h3 mb-0 fw-bold text-success">${finalPresentDays} <small class="text-muted fs-6">Worked</small></div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-primary shadow-sm">
            <div class="card-body py-3">
                <div class="text-muted small fw-bold text-uppercase mb-1">Total Leaves</div>
                <div class="h3 mb-0 fw-bold text-primary">
                    ${leaves.PL + leaves.CL + leaves.SL + leaves.FL + leaves.COFF}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100 border-start border-4 border-warning shadow-sm">
            <div class="card-body py-3">
                <div class="text-muted small fw-bold text-uppercase mb-1">Fixed Holidays</div>
                <div class="h3 mb-0 fw-bold text-warning">${fixedHolidaysCount}</div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100 border-0 shadow-sm bg-light">
            <div class="card-body">
                <div class="text-muted small fw-bold text-uppercase mb-3">Leave Breakdown</div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-center">
                        <div class="badge bg-white text-dark border px-3 py-2 mb-1">${leaves.PL}</div>
                        <div class="small text-muted">PL</div>
                    </div>
                    <div class="text-center">
                        <div class="badge bg-white text-dark border px-3 py-2 mb-1">${leaves.CL}</div>
                        <div class="small text-muted">CL</div>
                    </div>
                    <div class="text-center">
                        <div class="badge bg-white text-dark border px-3 py-2 mb-1">${leaves.SL}</div>
                        <div class="small text-muted">SL</div>
                    </div>
                    <div class="text-center">
                        <div class="badge bg-white text-dark border px-3 py-2 mb-1">${leaves.FL}</div>
                        <div class="small text-muted">FL</div>
                    </div>
                    <div class="text-center">
                        <div class="badge bg-white text-dark border px-3 py-2 mb-1">${leaves.COFF}</div>
                        <div class="small text-muted">CO</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100 nsa-total-card shadow">
            <div class="card-body d-flex justify-content-between align-items-center px-4">
                <div>
                    <div class="fw-bold text-uppercase small opacity-75">Final Combined NSA</div>
                    <div class="small opacity-50">Calculated for the month</div>
                </div>
                <div class="h1 mb-0 nsa-amount-text">‚Çπ${totalNsaAmount.toLocaleString()}</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header py-3">
                <i class="bi bi-clock-history me-2"></i> Detailed Shift NSA Breakdown
            </div>
            <div class="card-body p-4">
                ${breakdownHtml}
            </div>
        </div>
    </div>
</div>`;

  renderSummaryChart(finalPresentDays, leaves);

  deptSummaryPage = 1;
  await renderDepartmentSummary(month);
  document.getElementById('backSummaryBtn').classList.remove('d-none');
}

function renderSummaryChart(presentDays, leaves) {
    const ctx = document.getElementById('summaryChart');
    
    const totalDays = presentDays + leaves.PL + leaves.CL + leaves.SL + leaves.FL;
    if (totalDays === 0) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        return;
    }
    
    const data = {
        labels: ['Present', 'PL', 'CL', 'SL', 'FL'],
        datasets: [{
            data: [presentDays, leaves.PL, leaves.CL, leaves.SL, leaves.FL],
            backgroundColor: [
                'rgb(40, 167, 69)',   
                'rgb(255, 193, 7)',   
                'rgb(0, 123, 255)',   
                'rgb(220, 53, 69)',   
                'rgb(108, 117, 125)' 
            ],
            hoverOffset: 4
        }]
    };

    const config = {
        type: 'doughnut', 
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false, 
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: false,
                }
            }
        }
    };
    
    if (summaryChartInstance) {
        summaryChartInstance.destroy();
    }

    summaryChartInstance = new Chart(ctx, config);
}


async function renderDepartmentSummary(month) {
  const tbody = document.querySelector('#deptSummaryTable tbody');
  const paginationContainer = document.getElementById('deptSummaryPagination');
  
  // Set initial loading state
  tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Calculating reports...</td></tr>';
  
  try {
    // 1. Get employees (Uses fast cache)
    const allEmployees = await getEmployeesFromDB();
    const activeEmployees = allEmployees.filter(emp => emp.status === 'Active');
    
    // 2. Parallel Processing
    // Uses the optimized getMonthlyReportData which reuses cached NSA rules and holidays
    const allReports = await Promise.all(activeEmployees.map(emp => getMonthlyReportData(emp, month))); 

    const reportData = [];

    // 3. Process results locally
    allReports.forEach((report, index) => {
        const emp = activeEmployees[index];
        const { finalPresentDays, totalNsaAmount, shiftBreakdown, validWorkingDaysCount, leaves } = report;

        if (validWorkingDaysCount === 0) return; 

        if (finalPresentDays > 0 || Object.values(leaves).some(l => l > 0)) {
          reportData.push({ 
            emp, 
            days: finalPresentDays, 
            nsa: totalNsaAmount, 
            breakdown: shiftBreakdown 
          });
        }
    });

    // 4. Pagination Logic
    const totalPages = Math.ceil(reportData.length / ROWS_PER_PAGE);
    deptSummaryPage = Math.min(deptSummaryPage, totalPages) || 1;
    const start = (deptSummaryPage - 1) * ROWS_PER_PAGE;
    
    // Clear loading state
    tbody.innerHTML = '';
    
    if (reportData.length === 0) {
         tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No attendance data or NSA recorded for this month.</td></tr>';
         if (paginationContainer) paginationContainer.innerHTML = '';
         return;
    }

    // 5. High-Speed Rendering using Document Fragment
    // This builds the entire table page in memory before showing it to the user
    const fragment = document.createDocumentFragment();

    reportData.slice(start, start + ROWS_PER_PAGE).forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
          <td><strong>${item.emp.name}</strong></td>
          <td><span class="badge bg-light text-dark">${item.emp.department}</span></td>
          <td class="text-center">${item.days}</td>
          <td class="text-center">${item.breakdown.MORNING_8_5 || 0}</td>
          <td class="text-center">${item.breakdown.NIGHT_6_3 || 0}</td>
          <td class="text-center">${item.breakdown.NIGHT_9_30_6_30 || 0}</td>
          <td class="text-end fw-bold text-success">‚Çπ${item.nsa.toLocaleString()}</td>`;
      fragment.appendChild(tr);
    });

    // Single DOM update for the whole page
    tbody.appendChild(fragment);

    // 6. Update Pagination UI
    renderSummaryPagination(
      'deptSummaryPagination', 
      totalPages, 
      deptSummaryPage, 
      'renderDepartmentSummary', 
      'deptSummaryPage',
      `'${month}'`
    );

  } catch (error) {
    console.error("Summary Generation Error:", error);
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error generating summary. Please try again.</td></tr>';
  }
}

async function renderDeptMonthlySummary() {
    const dept = document.getElementById('deptSummaryDept').value;
    const month = document.getElementById('deptSummaryMonth').value;
    
    if(!dept || !month) { 
        alert('Please select both Department and Month to generate the breakdown.'); 
        return; 
    }
    
    deptMonthlySummaryPage = 1; 
    await renderDeptMonthlySummaryPage(dept, month);
}

async function renderDeptMonthlySummaryPage(dept, month) {
    const tbody = document.querySelector('#deptMonthlySummary tbody');
    const pageInfo = document.getElementById('deptPageInfo');
    
    // 1. Show DealerOn Branded Loading State
    tbody.innerHTML = `
        <tr>
            <td colspan="12" class="text-center py-5 text-muted">
                <div class="spinner-border spinner-border-sm me-2" style="color: #002147;"></div>
                Generating Departmental Breakdown...
            </td>
        </tr>`;

    const allEmployees = await getEmployeesFromDB();
    const reportData = [];

    // Filter only Active employees for the specific department
    const filteredEmployees = allEmployees.filter(emp => emp.department === dept && emp.status === 'Active');
    
    for (const emp of filteredEmployees) {
        const report = await getMonthlyReportData(emp, month);
        const { leaves, fixedHolidaysCount, finalPresentDays, totalNsaAmount, shiftBreakdown, validWorkingDaysCount } = report;

        if (validWorkingDaysCount === 0) continue; 

        if(finalPresentDays > 0 || Object.values(leaves).some(l => l > 0) || fixedHolidaysCount > 0) {
            reportData.push({ 
                emp, 
                finalPresentDays, 
                leaves, 
                fixedHolidaysCount, 
                nsaAmount: totalNsaAmount, 
                breakdown: shiftBreakdown 
            });
        }
    }

    // 2. Pagination Calculation
    const totalPages = Math.ceil(reportData.length / ROWS_PER_PAGE) || 1;
    deptMonthlySummaryPage = Math.min(deptMonthlySummaryPage, totalPages) || 1;
    const start = (deptMonthlySummaryPage - 1) * ROWS_PER_PAGE;
    const paginatedItems = reportData.slice(start, start + ROWS_PER_PAGE);

    // Update Footer Info Label
    if (pageInfo) {
        pageInfo.innerText = reportData.length > 0 
            ? `Showing ${start + 1}-${Math.min(start + ROWS_PER_PAGE, reportData.length)} of ${reportData.length} records`
            : "No records found";
    }

    tbody.innerHTML = '';

    if (reportData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" class="text-center py-5">
                    <h5 class="text-muted fw-bold">No Data Available</h5>
                    <p class="small">No attendance or NSA recorded for ${dept} in ${month}.</p>
                </td>
            </tr>`;
        document.getElementById('deptMonthlySummaryPagination').innerHTML = '';
        document.getElementById('backDeptSummaryBtn').classList.remove('d-none');
        return;
    }

    // 3. Rendering Table Rows
    paginatedItems.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = "align-middle"; // Perfect vertical alignment
        
        tr.innerHTML = `
            <td class="ps-3">
                <div class="fw-bold" style="color: #002147;">${item.emp.name}</div>
                <small class="text-muted" style="font-size: 0.7rem;">ID: ${item.emp.id}</small>
            </td>
            <td class="text-center fw-bold">${item.finalPresentDays}</td>
            <td class="text-center">${item.breakdown.MORNING_8_5 || 0}</td>
            <td class="text-center">${item.breakdown.NIGHT_6_3 || 0}</td>
            <td class="text-center">${item.breakdown.NIGHT_9_30_6_30 || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.PL || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.CL || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.SL || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.FL || 0}</td>
            <td class="text-center" style="background-color: #f0f7ff; color: #002147; font-weight: 600;">${item.leaves.COFF || 0}</td> 
            <td class="text-center" style="background-color: #fff9e6; color: #856404; font-weight: 600;">${item.fixedHolidaysCount || 0}</td> 
            <td class="text-end pe-3 fw-bold text-success">‚Çπ${item.nsaAmount.toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });

    // 4. Update Pagination UI
    renderSummaryPagination(
        'deptMonthlySummaryPagination', 
        totalPages, 
        deptMonthlySummaryPage, 
        'renderDeptMonthlySummaryPage', 
        'deptMonthlySummaryPage',
        `'${dept}', '${month}'`
    );

    document.getElementById('backDeptSummaryBtn').classList.remove('d-none');
}
/*********************
 * YEARLY SUMMARY LOGIC
 *********************/
async function getYearlyReportData(year, deptFilter) {
    const allEmployees = await getEmployeesFromDB();
    if (!allEmployees || allEmployees.length === 0) return [];

    // 1. De-duplication and Filtering
    const uniqueMap = new Map();
    allEmployees.forEach(emp => { if (emp.id) uniqueMap.set(emp.id, emp); });

    const activeEmployees = Array.from(uniqueMap.values()).filter(
        emp => emp.status === 'Active' && (!deptFilter || emp.department === deptFilter)
    );

    if (activeEmployees.length === 0) return [];
    
    // 2. Load Reference Data
    const holidays = await getHolidaysFromDB();
    const holidayDates = holidays.map(h => h.date);
    const allAttendance = await getAttendanceFromDB(); // Optimization: Get all records for the year once
    const nsaRules = await getNsaRulesFromDB();

    const getRecord = (empId, date) => {
        const recordKey = `${empId}_${date}`;
        return allAttendance.find(r => r.docId === recordKey);
    }

    const reportData = [];

    for (const emp of activeEmployees) {
        const empReport = {
            id: emp.id,
            name: emp.name,
            department: emp.department,
            shift: emp.shift,
            joinDate: emp.joinDate, 
            monthly: {} 
        };
        
        let yearlyPresentDays = 0;
        let yearlyLeaves = { PL: 0, CL: 0, SL: 0, FL: 0, COFF: 0 }; // Added COFF
        let yearlyFH = 0; // Added FH counter
        let yearlyNSA = 0;
        let yearlyShiftBreakdown = { MORNING_8_5: 0, NIGHT_6_3: 0, NIGHT_9_30_6_30: 0 }; 

        // Loop through 12 months
        for (let m = 1; m <= 12; m++) {
            const monthKey = `${year}-${String(m).padStart(2, '0')}`;
            const daysInMonth = new Date(year, m, 0).getDate();
            
            let leaves = { PL: 0, CL: 0, SL: 0, FL: 0, COFF: 0 }; // Added COFF
            let presentDays = 0;
            let nsa = 0;
            let fhCount = 0; // Fixed Holiday counter for the month
            let shiftBreakdown = { MORNING_8_5: 0, NIGHT_6_3: 0, NIGHT_9_30_6_30: 0 };

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${monthKey}-${String(d).padStart(2, '0')}`;
                
                // Skip if before join date
                if (dateStr < emp.joinDate) continue;

                const dateObj = new Date(year, m - 1, d);
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                const isHoliday = holidayDates.includes(dateStr);
                const record = getRecord(emp.id, dateStr);

                // LOGIC 1: Manual Presence (Weekends included) OR Default Weekday Presence
                if ((record && record.status === 'PRESENT') || (!isWeekend && !isHoliday && !record)) {
                    presentDays++;
                    // Priority: Custom Shift Override > Default Shift
                    const effectiveShiftKey = (record && record.customShift) ? record.customShift : emp.shift;
                    const nsaPerDay = nsaRules[effectiveShiftKey]?.amount || 0;
                    
                    nsa += nsaPerDay;
                    if (shiftBreakdown.hasOwnProperty(effectiveShiftKey)) {
                        shiftBreakdown[effectiveShiftKey]++;
                        yearlyShiftBreakdown[effectiveShiftKey]++; 
                    }
                } 
                // LOGIC 2: Leaves (Including COFF)
                else if (record && record.status === 'LEAVE' && record.leaveType) {
                    if (leaves.hasOwnProperty(record.leaveType)) {
                        leaves[record.leaveType]++;
                        yearlyLeaves[record.leaveType]++;
                    }
                }
                // LOGIC 3: Fixed Holidays (FH)
                else if (isHoliday) {
                    fhCount++;
                    yearlyFH++;
                }
            }
            
            yearlyPresentDays += presentDays;
            yearlyNSA += nsa;
            
            empReport.monthly[monthKey] = { 
                presentDays, 
                leaves, 
                nsa, 
                fh: fhCount, // Added FH to monthly breakdown
                breakdown: shiftBreakdown 
            };
        }

        empReport.presentDays = yearlyPresentDays;
        empReport.leaves = yearlyLeaves;
        empReport.fh = yearlyFH; // Added FH to yearly total
        empReport.nsa = yearlyNSA;
        empReport.yearlyBreakdown = yearlyShiftBreakdown; 

        // Only push if there is some activity
        if (empReport.presentDays > 0 || Object.values(empReport.leaves).some(l > 0) || empReport.fh > 0) {
            reportData.push(empReport);
        }
    }
    return reportData;
}

// Global variable for Yearly pagination
let yearlySummaryPage = 1;
const YEARLY_ROWS_PER_PAGE = 10;

async function renderYearlySummary(page = 1) {
    const year = document.getElementById('yearlySummaryYear').value;
    const deptFilter = document.getElementById('yearlySummaryDept').value;
    const tbody = document.querySelector('#yearlySummaryResults tbody');
    const pageInfo = document.getElementById('yearlyPageInfo');
    const backBtn = document.getElementById('backYearlyBtn');
    
    // 1. DealerOn Loading State
    tbody.innerHTML = `
        <tr>
            <td colspan="11" class="text-center py-5 text-muted">
                <div class="spinner-border spinner-border-sm me-2" style="color: #002147;"></div>
                Compiling Annual Records for ${year}...
            </td>
        </tr>`;

    // Validation
    if (!year || year.length !== 4) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger py-4 fw-bold">Please enter a valid 4-digit year.</td></tr>';
        return;
    }
    
    yearlySummaryPage = page;
    
    // Fetch Data from your existing engine
    const reportData = await getYearlyReportData(year, deptFilter);
    
    // 2. Pagination Logic
    const totalItems = reportData.length;
    const totalPages = Math.ceil(totalItems / YEARLY_ROWS_PER_PAGE) || 1;
    const start = (yearlySummaryPage - 1) * YEARLY_ROWS_PER_PAGE;
    const paginatedItems = reportData.slice(start, start + YEARLY_ROWS_PER_PAGE);

    // Update Footer Label
    if (pageInfo) {
        pageInfo.innerText = totalItems > 0 
            ? `Showing ${start + 1}-${Math.min(start + YEARLY_ROWS_PER_PAGE, totalItems)} of ${totalItems} Associates`
            : "No records found";
    }

    tbody.innerHTML = '';
    
    // Handle Empty Results
    if (reportData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center py-5 text-muted">No attendance data or NSA recorded for this group.</td></tr>';
        renderSummaryPagination('yearlySummaryPagination', 0, 1, 'renderYearlySummary', 'yearlySummaryPage');
        if (backBtn) backBtn.classList.remove('d-none'); // Show reset even if empty
        return;
    }

    // 3. Render Rows with DealerOn High-Contrast Styling
    paginatedItems.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = "align-middle";
        tr.innerHTML = `
            <td class="ps-3 fw-bold" style="color: #002147;">${item.name}</td>
            <td><span class="badge border bg-light text-dark fw-normal px-2 py-1">${item.department}</span></td>
            <td class="text-center fw-bold">${item.presentDays}</td>
            <td class="text-center">${item.yearlyBreakdown.MORNING_8_5 || 0}</td>
            <td class="text-center">${item.yearlyBreakdown.NIGHT_6_3 || 0}</td>
            <td class="text-center">${item.yearlyBreakdown.NIGHT_9_30_6_30 || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.PL || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.CL || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.SL || 0}</td>
            <td class="text-center text-primary fw-bold">${item.leaves.FL || 0}</td>
            <td class="text-end pe-3 fw-bold text-success">‚Çπ${item.nsa.toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });

    // 4. UI Polish: Show Reset Button & Update Pagination
    if (backBtn) backBtn.classList.remove('d-none');

    renderSummaryPagination(
        'yearlySummaryPagination', 
        totalPages, 
        yearlySummaryPage, 
        'renderYearlySummary', 
        'yearlySummaryPage'
    );
}

// 5. Associated Reset Function
function resetYearlySummary() {
    document.getElementById('yearlySummaryYear').value = "2025";
    document.getElementById('yearlySummaryDept').value = "";
    
    const tbody = document.querySelector('#yearlySummaryResults tbody');
    tbody.innerHTML = '<tr><td colspan="11" class="text-center py-5 text-muted">Select a year and click Generate.</td></tr>';
    
    document.getElementById('yearlySummaryPagination').innerHTML = '';
    document.getElementById('yearlyPageInfo').innerText = 'Showing 0 of 0 records';
    document.getElementById('backYearlyBtn').classList.add('d-none');
    
    yearlySummaryPage = 1;
}

/*********************
 * MONTHLY BREAKDOWN MODAL 
 *********************/
async function viewMonthlyBreakdown() {
    const year = document.getElementById('yearlySummaryYear').value;
    const deptFilter = document.getElementById('yearlySummaryDept').value;
    
    if (!year || year.length !== 4) {
        alert('Please select a valid year first.');
        return;
    }
    
    const reportData = await getYearlyReportData(year, deptFilter);

    if (reportData.length === 0) {
        alert('No data to display. Generate the Yearly Summary first.');
        return;
    }

    await renderMonthlyBreakdown(reportData, year, deptFilter);
    new bootstrap.Modal(document.getElementById('monthlyBreakdownModal')).show();
}

async function renderMonthlyBreakdown(reportData, year, deptFilter) {
    const title = document.getElementById('monthlyBreakdownTitle');
    const header = document.getElementById('monthlyBreakdownHeader');
    const body = document.getElementById('monthlyBreakdownBody');
    const footer = document.getElementById('monthlyBreakdownFooter');

    title.textContent = `Monthly Breakdown - Year ${year} (${deptFilter || 'All Departments'})`;
    header.innerHTML = '';
    body.innerHTML = '';
    footer.innerHTML = '';

    const allMonths = Object.keys(reportData[0].monthly).sort(); 

    // --- SPEED FIX 1: Fetch all working days for the year upfront ---
    const workingDaysCache = {};
    await Promise.all(allMonths.map(async (monthKey) => {
        const m = parseInt(monthKey.split('-')[1]);
        workingDaysCache[monthKey] = await getWorkingDays(Number(year), m);
    }));
    
    const shiftCodes = {
        MORNING_8_5: 'SC-M',
        NIGHT_6_3: 'SC-N1',
        NIGHT_9_30_6_30: 'SC-N2'
    };

    // --- 1. Construct Header ---
    const headerRow1 = document.createElement('tr');
    const headerRow2 = document.createElement('tr');
    headerRow1.innerHTML += `<th rowspan="2">Employee</th><th rowspan="2">Dept</th>`;

    for (const monthKey of allMonths) {
        const monthName = MONTH_NAMES[parseInt(monthKey.split('-')[1]) - 1];
        headerRow1.innerHTML += `<th colspan="12" class="text-center bg-dark text-white">${monthName}</th>`;
        headerRow2.innerHTML += `
            <th>P(T)</th><th>${shiftCodes.MORNING_8_5}</th><th>${shiftCodes.NIGHT_6_3}</th><th>${shiftCodes.NIGHT_9_30_6_30}</th>
            <th>PL</th><th>CL</th><th>SL</th><th>FL</th>
            <th class="table-info">COFF</th> 
            <th class="table-warning">FH</th>
            <th>NSA(‚Çπ)</th><th>W Days</th>`;
    }

    headerRow1.innerHTML += `<th rowspan="2">Yearly P</th><th rowspan="2">Yearly L</th><th rowspan="2">Yearly NSA (‚Çπ)</th>`;
    header.appendChild(headerRow1);
    header.appendChild(headerRow2);

    // --- 2. Construct Body (Using Fragment for speed) ---
    const bodyFragment = document.createDocumentFragment();

    for (const item of reportData) {
        const totalLeaves = item.leaves.PL + item.leaves.CL + item.leaves.SL + item.leaves.FL + item.leaves.COFF;
        const tr = document.createElement('tr');
        
        // Build row HTML as a string first (faster than multiple appends)
        let rowHtml = `<td><strong>${item.name}</strong></td><td><small>${item.department}</small></td>`;

        for (const monthKey of allMonths) {
            const data = item.monthly[monthKey];
            const monthWorkingDays = workingDaysCache[monthKey] || [];
            const empWorkingDaysCount = monthWorkingDays.filter(date => date >= item.joinDate).length;

            rowHtml += `
                <td>${data.presentDays}</td>
                <td>${data.breakdown.MORNING_8_5 || 0}</td>
                <td>${data.breakdown.NIGHT_6_3 || 0}</td>
                <td>${data.breakdown.NIGHT_9_30_6_30 || 0}</td>
                <td>${data.leaves.PL}</td><td>${data.leaves.CL}</td><td>${data.leaves.SL}</td><td>${data.leaves.FL}</td>
                <td class="table-info">${data.leaves.COFF}</td>
                <td class="table-warning">${data.fh}</td>
                <td class="fw-bold">‚Çπ${data.nsa}</td>
                <td class="text-muted small">${empWorkingDaysCount}</td>`;
        }

        rowHtml += `
            <td class="table-info fw-bold">${item.presentDays}</td>
            <td class="table-danger fw-bold">${totalLeaves}</td>
            <td class="table-warning fw-bold">‚Çπ${item.nsa.toLocaleString()}</td>`;

        tr.innerHTML = rowHtml;
        bodyFragment.appendChild(tr);
    }
    body.appendChild(bodyFragment);

    // --- 3. Construct Footer (Grand Totals) ---
    const totalRow = document.createElement('tr');
    totalRow.className = 'table-dark fw-bold';
    totalRow.innerHTML += `<td colspan="2">GRAND TOTAL</td>`;

    let grandTotalP = 0;
    let grandTotalL = 0;
    let grandTotalNSA = 0;

    for (const monthKey of allMonths) {
        let mT = { p:0, scm:0, scn1:0, scn2:0, pl:0, cl:0, sl:0, fl:0, coff:0, fh:0, nsa:0 };
        const monthWorkingDaysCount = (workingDaysCache[monthKey] || []).length;

        reportData.forEach(item => {
            const data = item.monthly[monthKey];
            mT.p += data.presentDays;
            mT.scm += data.breakdown.MORNING_8_5 || 0;
            mT.scn1 += data.breakdown.NIGHT_6_3 || 0;
            mT.scn2 += data.breakdown.NIGHT_9_30_6_30 || 0;
            mT.pl += data.leaves.PL; mT.cl += data.leaves.CL; mT.sl += data.leaves.SL; mT.fl += data.leaves.FL;
            mT.coff += data.leaves.COFF; mT.fh += data.fh; mT.nsa += data.nsa;
        });
        
        grandTotalP += mT.p;
        grandTotalL += (mT.pl + mT.cl + mT.sl + mT.fl + mT.coff);
        grandTotalNSA += mT.nsa;

        totalRow.innerHTML += `
            <td>${mT.p}</td><td>${mT.scm}</td><td>${mT.scn1}</td><td>${mT.scn2}</td>
            <td>${mT.pl}</td><td>${mT.cl}</td><td>${mT.sl}</td><td>${mT.fl}</td>
            <td>${mT.coff}</td><td>${mT.fh}</td><td>‚Çπ${mT.nsa}</td>
            <td>${monthWorkingDaysCount}</td>`;
    }

    totalRow.innerHTML += `
        <td>${grandTotalP}</td><td>${grandTotalL}</td><td>‚Çπ${grandTotalNSA.toLocaleString()}</td>`;

    footer.appendChild(totalRow);
}

/*********************
 * EMPLOYEE HISTORY VIEW
 *********************/
let currentEmployeeHistoryRecords = [];

async function viewEmployeeHistory(empId) {
    currentHistoryEmpId = empId;
    const emp = await getEmployeeById(empId);
    if (!emp) return;

    document.getElementById('employeeHistoryTitle').textContent = `Attendance History: ${emp.name} (${emp.id})`;
    
    // Fetch all attendance records for this employee
    const allRecords = await getAttendanceFromDB(empId);

    // Add a helper field for easy filtering/sorting/deleting
    currentEmployeeHistoryRecords = allRecords.map(record => ({
        ...record,
        docId: `${record.empId}_${record.date}` // Reconstruct the document ID key
    })).sort((a, b) => b.date.localeCompare(a.date));

    document.getElementById('historyFilterDate').value = '';
    document.getElementById('historyFilterStatus').value = '';
    filterEmployeeHistory();

    new bootstrap.Modal(document.getElementById('employeeHistoryModal')).show();
}

async function filterEmployeeHistory() {
    const filterDate = document.getElementById('historyFilterDate').value;
    const filterStatus = document.getElementById('historyFilterStatus').value;
    const tbody = document.getElementById('employeeHistoryBody');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Filtering records...</td></tr>';
    
    const nsaRules = await getNsaRulesFromDB();

    const filteredRecords = currentEmployeeHistoryRecords.filter(record => {
        const dateMatch = !filterDate || record.date.includes(filterDate);
        
        let statusMatch;
        if (filterStatus === 'SHIFT_OVERRIDE') {
            statusMatch = record.customShift && record.status === 'PRESENT';
        } else {
            statusMatch = !filterStatus || record.status === filterStatus;
        }

        return dateMatch && statusMatch;
    });
    
    tbody.innerHTML = '';
    
    if (filteredRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No matching history records found.</td></tr>';
        return;
    }

    filteredRecords.forEach(record => {
        const tr = document.createElement('tr');
        
        let statusClass = '';
        let statusText = '';
        let detailsText = record.leaveType || '-';

        if (record.status === 'PRESENT' && record.customShift) {
             statusClass = 'bg-info text-dark';
             statusText = 'Shift Override';
             detailsText = nsaRules[record.customShift]?.name || record.customShift;
        } else if (record.status === 'PRESENT') {
             statusClass = 'bg-success text-white';
             statusText = 'PRESENT';
        } else if (record.status === 'LEAVE') {
             statusClass = 'bg-danger text-white';
             statusText = 'LEAVE';
        }

        tr.innerHTML = `
            <td>${record.date}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td>${detailsText}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="deleteHistoryRecord('${record.date}')">Clear</button></td>
        `;
        tbody.appendChild(tr);
    });
}

async function deleteHistoryRecord(dateToDelete) {
    if (!currentHistoryEmpId || !dateToDelete) return;

    if (!confirm(`Are you sure you want to delete the attendance record for ${currentHistoryEmpId} on ${dateToDelete}?`)) {
        return;
    }

    const docId = `${currentHistoryEmpId}_${dateToDelete}`;
    
    if (await deleteAttendanceRecordFromDB(docId)) {
        // Update local cache
        currentEmployeeHistoryRecords = currentEmployeeHistoryRecords.filter(r => r.date !== dateToDelete);
        
        const activeEmpId = document.getElementById('attendanceEmployee').value;
        const activeMonth = document.getElementById('attendanceMonth').value;
        if (activeEmpId === currentHistoryEmpId && dateToDelete.startsWith(activeMonth)) {
            renderCalendar();
        }
        
        filterEmployeeHistory();
    } else {
        alert('Failed to delete history record.');
    }
}


/*********************
 * EXPORT TO EXCEL
 *********************/
function exportDeptSummary(){
  const table=document.getElementById('deptSummaryTable');
  if (table.querySelector('tbody tr td')?.textContent.includes('No attendance data')) {
      alert('No data to export. Generate the summary first.');
      return;
  }
  const wb=XLSX.utils.table_to_book(table,{sheet:"Department Summary"});
  XLSX.writeFile(wb,`Department_Summary.xlsx`);
}

async function exportEmpSummary(){
  const empId=document.getElementById('summaryEmployee').value; 
  const month=summaryMonth.value;
  if(!empId||!month){ alert('Select an employee and month'); return; }
  const emp=await getEmployeeById(empId);
  
  if(!emp) return;

  const [year, m] = month.split('-').map(Number);
  const allWorkingDaysInMonth = await getWorkingDays(year, m); 
  const validWorkingDays = allWorkingDaysInMonth.filter(date => date >= emp.joinDate);
  
  if(validWorkingDays.length === 0){ alert('No valid working days for this employee this month.'); return; }
  
  // Fetch all records for the month
  const records = await getAttendanceFromDB(empId, month);
  const getRecordByDate = (date) => {
      const recordKey = `${empId}_${date}`;
      return records.find(r => r.docId === recordKey);
  }
  
  const exportData = [];
  for (const date of validWorkingDays) {
      const record = getRecordByDate(date);
      const isLeave = record && record.status === 'LEAVE';
      
      let status = 'PRESENT (Default)';
      let leaveType = '';
      let shift = emp.shift;
      
      let nsaInfo = { amount: 0 };
      if (!isLeave) {
          nsaInfo = await getDailyNsaInfo(emp, date);
          shift = nsaInfo.shift;
      }

      if(isLeave) {
          status = 'LEAVE';
          leaveType = record.leaveType || '';
          shift = 'N/A';
      } else if (record && record.customShift) { 
          status = 'PRESENT (Shift Override)';
      }
      
      exportData.push({
          Date: date,
          'Day of Week': DAY_NAMES[new Date(date).getDay()],
          Status: status,
          LeaveType: leaveType,
          'Effective Shift Key': shift,
          'NSA Amount (‚Çπ)': isLeave ? 0 : nsaInfo.amount
      });
  }
  
  const ws=XLSX.utils.json_to_sheet(exportData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,`${emp.name} Summary`);
  XLSX.writeFile(wb,`${emp.name}_Monthly_Details.xlsx`);
}

async function exportDeptMonthlySummary() {
  const dept = document.getElementById('deptSummaryDept').value;
  const month = document.getElementById('deptSummaryMonth').value;
  if(!dept || !month) { alert('Select both department and month'); return; }

  const data = [];
  const allEmployees = await getEmployeesFromDB();
  const filteredEmployees = allEmployees.filter(e => e.department === dept && e.status==='Active');
  
  for (const emp of filteredEmployees) {
      const report = await getMonthlyReportData(emp, month);
      const { leaves, finalPresentDays, totalNsaAmount, shiftBreakdown, validWorkingDaysCount } = report;

      if (validWorkingDaysCount === 0 || (finalPresentDays === 0 && Object.values(leaves).every(l => l === 0))) continue;

      data.push({
        Employee: emp.name,
        'Working Days (P)': finalPresentDays,
        'M-Shift (SC-M)': shiftBreakdown.MORNING_8_5,
        'N1-Shift (SC-N6-3)': shiftBreakdown.NIGHT_6_3,
        'N2-Shift (SC-N9-6)': shiftBreakdown.NIGHT_9_30_6_30,
        PL: leaves.PL,
        CL: leaves.CL,
        SL: leaves.SL,
        FL: leaves.FL,
        'Total NSA (‚Çπ)': totalNsaAmount
      });
  }

  if(data.length===0){ alert('No data to export'); return; }

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, `${dept}_${month}`);
  XLSX.writeFile(wb, `${dept}_${month}_Breakdown.xlsx`);
}

function exportYearlySummary() {
  const table = document.querySelector('#yearlySummaryResults table');
  const year = document.getElementById('yearlySummaryYear').value;
  const dept = document.getElementById('yearlySummaryDept').value || 'All';
  
  // Validation to ensure data exists before export
  if (!table || 
      table.querySelector('tbody').children.length === 0 || 
      (table.querySelector('tbody td') && table.querySelector('tbody td').textContent.includes('Select a year')) ||
      (table.querySelector('tbody td') && table.querySelector('tbody td').textContent.includes('Calculating'))) {
    alert('No data to export. Please generate the yearly summary first.');
    return;
  }
  
  // Clean the sheet name (Excel sheet names cannot exceed 31 characters or contain certain symbols)
  let safeSheetName = `${dept.substring(0, 10)}_${year}_Summary`.replace(/[\\?*:[\]/]/g, "");

  // Convert the HTML table to an Excel Workbook
  // This automatically includes the new COFF and FH columns we added to the UI
  const wb = XLSX.utils.table_to_book(table, { 
    sheet: safeSheetName,
    raw: true // Ensures numbers like NSA totals are handled correctly
  });

  // Set column widths for better readability in the exported file
  const ws = wb.Sheets[safeSheetName];
  const wscols = [
    {wch: 25}, // Employee Name
    {wch: 10}, // Present
    {wch: 6},  // PL
    {wch: 6},  // CL
    {wch: 6},  // SL
    {wch: 6},  // FL
    {wch: 8},  // COFF (New)
    {wch: 8},  // FH (New)
    {wch: 15}, // Total NSA
    {wch: 12}  // Action
  ];
  ws['!cols'] = wscols;

  // Final file generation
  XLSX.writeFile(wb, `${dept}_Dept_${year}_Yearly_Attendance_Summary.xlsx`);
}

function exportMonthlyBreakdown() {
  const table = document.getElementById('monthlyBreakdownTable');
  const year = document.getElementById('yearlySummaryYear').value;
  const dept = document.getElementById('yearlySummaryDept').value || 'All';
  
  if (!table || table.querySelector('tbody').children.length === 0) {
    alert('No data to export. Generate the Yearly Summary and view the breakdown table first.');
    return;
  }
  
  // Use table_to_book which handles merged headers
  const wb = XLSX.utils.table_to_book(table, { sheet: `${dept}_${year}_Monthly_Breakdown`, raw: true });
  XLSX.writeFile(wb, `${dept}_${year}_Monthly_Breakdown_Detailed.xlsx`);
}


// Call dropdown population on DOM load
document.addEventListener('DOMContentLoaded', async () => {
  await renderHolidaysList(); 
  await renderNsaRules(); 
  await populateDepartmentFilter();
  await populateDeptDropdown('deptSummaryDept');
  await populateDeptDropdown('yearlySummaryDept');
  await initAttendance(); 
  await renderEmployees(); 
  document.getElementById('yearlySummaryYear').value = new Date().getFullYear(); 
  document.getElementById('summaryMonth').value = new Date().toISOString().slice(0,7);
  document.getElementById('deptSummaryMonth').value = new Date().toISOString().slice(0,7);
});

async function handleExcelUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0]; 
      const worksheet = workbook.Sheets[sheetName];
      // Added raw: false to ensure dates are read as strings from your Excel
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });

      const employees = await getEmployeesFromDB();
      let newEmployeesCount = 0;
      const batch = db.batch();

      jsonData.forEach(row => {
        // Map Excel headers to local variables
        const rawId = row.ID || row.id;
        const name = row.Name || row.name;
        const dept = row.Department || row.department;
        const jDate = row.JoinDate || row.joinDate;

        // Validation check
        if(!rawId || !name || !dept || !jDate) return; 
        
        // Force ID to string so it matches your DB document ID format
        const stringId = String(rawId).trim();

        if (employees.some(e => e.id === stringId)) return; 

        const newEmployee = {
          id: stringId,
          name: name,
          department: dept,
          joinDate: jDate, 
          shift: row.Shift || row.shift || 'MORNING_8_5',
          status: row.Status || row.status || 'Active'
        };
        
        batch.set(db.collection(EMPLOYEES_COLLECTION).doc(newEmployee.id), newEmployee);
        newEmployeesCount++;
      });

      if (newEmployeesCount === 0) {
          return alert("No new employees to add. (Check for duplicates or empty fields).");
      }

      await batch.commit();
      
      // Refresh UI Components
      await renderEmployees();
      await populateDepartmentFilter();
      await populateAttendanceEmployees();
      await populateDeptDropdown('deptSummaryDept');
      await populateDeptDropdown('yearlySummaryDept');

      alert(`${newEmployeesCount} unique employees uploaded successfully.`);
    } catch (err) {
        console.error("Excel upload failed:", err);
        alert('Failed to upload employees. Ensure you are logged in.');
    }
  };
  reader.readAsArrayBuffer(file);
}

// This registers the sw.js file you just created
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('‚úÖ PWA ready: Service Worker Registered'))
            .catch(err => console.error('‚ùå PWA failed:', err));
    });
}

</script>
</body>
</html>
